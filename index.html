<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="utils.js"></script>
    <script>
      window.obfuscatedFirebaseConfig = "ZDt7ZG1cdwwqNzguWQ95dGpWa-V-fPIaUfTaVlp6cuVrL2g5U3xbTD9kUQZaBF9lUSIEoRB68V5M1vZIfERaoyU7fGNpdD8UYSBoDnQcdwpyYlajVHL2T0bz6kB8XUSvfHZ3Nig1YgdnZ38MZDx8BSkwQPpfeKlLTb_rRHlEW6x-aWo2KDVhAWd_ewh1N21EeHdSrwg54l1J8bREdABG4HtwdTllZ2JbaX1qHGAabAlwfUuvHjnpT1fh-EJ0Q1PSend-cXZedlcyLytcJEMvHyUjHrkAKqYGBvPpVVRJFrs9KCAlNyMkQjA7K1ckRykdZHdEt1N65RkVpKERf0sGsCZ8fCc9JncWP244QzIYfUZgZ1ToX37qXm32ux8_ahnPK1otR1NaRSUwLzZNdBRsRnFzVehnScgIHrDxUWldR7swNnxjaXQ_FGEgaA50HHcKcmJWoFZ-4ktR_u0Ib1lQ4zF_c2ZhdXMGbWR1QXMadQVu";
    </script>
    <meta charset="UTF-8" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="./manifest.json?v=1.3.8" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="./icon-192x192.png?v=1.3.8"
    />
    <link rel="apple-touch-icon" href="./icon-192x192.png?v=1.3.8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand+SC&display=swap" rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="theme-color" content="#3498db" />
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline' https://www.gstatic.com https://*.firebaseio.com https://*.firebase.com https://*.googleapis.com; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com; object-src 'self';"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <audio
      id="audioPlayer"
      preload="auto"
      playsinline
      webkit-playsinline
    ></audio>
    <title>FWMC-AI RADIO</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    
    

    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --background-color: linear-gradient(135deg, #add8e6, #fae6f2);
        --text-color: #2c3e50;
        --white: #ffffff;
        --gray: #bdc3c7;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      input,
      button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -moz-appearance: none;
        appearance: none;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
      }

      body {
    font-family: "Roboto", sans-serif;
    color: var(--text-color);
    min-height: 100vh;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 150px;
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        url('images/background-overlay.png'),
        var(--background-color);
    background-size: cover, auto;
    background-position: center, 0 0;
    background-repeat: no-repeat, repeat;
    opacity: 0.3; /* Adjust this value to control the overlay intensity */
    z-index: -1;
    pointer-events: none;
}

      /*h1 {
        font-family: "Orbitron", sans-serif;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        color: var(--primary-color);
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        letter-spacing: 3px;
      }*/

      #mainHeader {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  #headerLogo {
    max-width: 200%;
    height: fit-content;
    max-height: 200px;
    width: auto;
  }

  @media (max-width: 768px) {
    #headerLogo {
      max-height: 120px;
    }
  }

  @media (max-width: 480px) {
    #headerLogo {
      max-height: 100px;
    }
  }

      .playlist {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        width: 100%;
        max-width: 1200px;
        padding-bottom: 100px;
      }

      .song {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(70, 130, 180, 0.2);
    width: 100%;
    max-width: 100%;
    position: relative;
    transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
    z-index: 1;
    height: 100%;
}

.song-info-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    width: 100%;
}

      .song-tag {
        position: absolute;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: bold;
        z-index: 2;
      }

      .new-tag {
        top: 5px;
        right: 5px;
        background-color: #ff4500;
        color: white;
      }

      .turtle-tag {
        top: -15px;
        left: 3px;
        background-color: transparent;
        color: white;
        font-size: 1rem;
      }

      .song.moving-left {
        transform: translateX(-100%);
        opacity: 0.7;
      }

      .song.moving-right {
        transform: translateX(100%);
        opacity: 0.7;
      }

      .song.slide-in {
        animation: slideIn 0.3s ease forwards;
      }

      @keyframes slideIn {
        from {
          transform: translateX(0);
          opacity: 0.7;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .song-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    flex-grow: 1;
}

      .song-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 0.5rem;
        width: 100%;
      }

      .button-group {
        margin-top: 0.5rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
      }

      .move-btn,
      .remove-from-playlist-btn,
      .add-to-playlist-btn {
        flex: 1;
        padding: 0.5rem;
        font-size: 0.8rem;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
      }

      .move-btn {
        background-color: var(--primary-color);
        color: var(--white);
      }

      .remove-from-playlist-btn {
        background-color: #e74c3c;
        color: var(--white);
      }

      .add-to-playlist-btn {
        background-color: var(--secondary-color);
        color: var(--white);
      }

      @media (max-width: 768px) {
        .control-row {
          flex-wrap: wrap;
        }
        .move-btn,
        .remove-from-playlist-btn,
        .add-to-playlist-btn {
          flex-basis: calc(33.33% - 0.5rem);
          margin-bottom: 0.5rem;
        }
      }

      .song-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        width: 100%;
      }

      .move-btn {
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .move-btn:hover {
        background-color: var(--secondary-color);
      }

      .move-btn:disabled {
        background-color: var(--gray);
        cursor: not-allowed;
      }

      .song img {
    width: 100%;
    height: auto;
    object-fit: cover;
    aspect-ratio: 1 / 1;
    border-radius: 10px;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.song-title,
.cover-artists,
.original-artists {
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0.1rem 0;
    padding: 0;
    line-height: 1.2;
}

.song-title {
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1rem;
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    white-space: normal;
    max-height: 2.4em;
}

.cover-artists {
    font-size: 0.85rem;
    color: #d1439b;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    max-height: 2.4em;
}

.original-artists {
    font-size: 0.85rem;
    color: #9064e2;
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    white-space: normal;
    max-height: 2.4em;
}

.play-count {
    margin-top: auto;
    padding-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--secondary-color);
}

/* Responsive adjustments */
@media screen and (max-width: 320px) {
    .song {
        padding: 0.5rem;
    }

    .song-title {
        font-size: 0.85rem;
        -webkit-line-clamp: 2;
        max-height: 2.4em;
    }

    .cover-artists,
    .original-artists {
        font-size: 0.7rem;
        -webkit-line-clamp: 1;
        max-height: 1.2em;
    }

    .play-count {
        font-size: 0.6rem;
        padding-top: 0.25rem;
    }
}

@media screen and (min-width: 321px) and (max-width: 480px) {
    .song {
        padding: 0.75rem;
    }

    .song-title {
        font-size: 0.9rem;
    }

    .cover-artists,
    .original-artists {
        font-size: 0.75rem;
    }

    .play-count {
        font-size: 0.65rem;
    }
}

@media screen and (min-width: 481px) and (max-width: 768px) {
    .song {
        padding: 0.75rem;
    }

    .song-title {
        font-size: 0.95rem;
    }

    .cover-artists,
    .original-artists {
        font-size: 0.8rem;
    }

    .play-count {
        font-size: 0.7rem;
    }
}

@media screen and (min-width: 769px) and (max-width: 1024px) {
    .song {
        padding: 0.75rem;
    }

    .song-title {
        font-size: 1rem;
    }

    .cover-artists,
    .original-artists {
        font-size: 0.85rem;
    }

    .play-count {
        font-size: 0.75rem;
    }
}

@media screen and (min-width: 1025px) {
    .song {
        padding: 1rem;
    }

    .song-title {
        font-size: 1.1rem;
    }

    .cover-artists,
    .original-artists {
        font-size: 0.9rem;
    }

    .play-count {
        font-size: 0.8rem;
    }
}

      .player-container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        width: 90%;
        max-width: 600px;
        background-color: var(--primary-color);
        border-radius: 30px 30px 0 0;
        padding: 1rem;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease-out;
        visibility: hidden;
        z-index: 999;
      }

      .player-container.visible {
        transform: translateX(-50%) translateY(0);
        visibility: visible;
      }

      .player-container.minimized {
        transform: translateX(-50%) translateY(calc(100% - 60px));
        visibility: visible;
      }

      .toggle-player-btn {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 15px 15px 0 0;
        padding: 5px 20px;
        cursor: pointer;
        font-size: 0.8rem;
        z-index: 10;
      }

      .player-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }

      .progress-container {
        width: 100%;
        height: 30px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        margin-bottom: 10px;
      }

      #progressVisualizer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #progressBar {
        height: 100%;
        background-color: rgba(255, 255, 255, 0.3);
        width: 0;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      /* Volume control container */
      .volume-container {
        display: flex;
        align-items: center;
        width: 100px;
      }

      /* Custom slider styling */
      #volumeControl {
        width: 80px;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      #volumeControl:hover {
        opacity: 1;
      }

      #volumeControl::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 10px;
        height: 10px;
        background: #4caf50;
        cursor: pointer;
        border-radius: 50%;
      }

      #volumeControl::-moz-range-thumb {
        width: 10px;
        height: 10px;
        background: #4caf50;
        cursor: pointer;
        border-radius: 50%;
        border: none;
      }

      .song-info {
        text-align: center;
        margin-bottom: 0.5rem;
        height: 20px;
        overflow: hidden;
      }

      #currentSong {
        font-weight: bold;
        color: var(--white);
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .control-btn {
        background-color: var(--white);
        color: var(--primary-color);
        border: none;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease, transform 0.1s ease,
          color 0.3s ease;
        padding: 0;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
      }

      .control-btn:hover {
        background-color: var(--gray);
      }

      .control-btn:active {
        transform: scale(0.95);
      }

      #repeatBtn.active {
        background-color: var(--secondary-color);
        color: var(--white);
      }

      #repeatBtn.active svg {
        fill: var(--white);
      }

      .controls-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 1200px;
        margin-bottom: 1rem;
        gap: 0.5rem;
      }

      /* Search container styles */
      .search-container {
        display: grid;
        grid-template-columns: 1fr auto;
        height: 40px;
      }

      /* Base styles for both input and button */
      #searchInput,
      #searchBtn {
        box-sizing: border-box;
        height: 100%; /* Fill the container height */
        font-size: 16px;
        border: 1px solid var(--primary-color);
        line-height: 38px; /* height - 2px for borders */
        padding: 0 1rem;
      }

      /* Search input styles */
      #searchInput {
        flex-grow: 1;
        border-radius: 20px 0 0 20px;
        border-right: none; /* Remove right border to prevent double border */
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      /* Search button styles */
      #searchBtn {
        border-radius: 0 20px 20px 0;
        background-color: var(--primary-color);
        color: var(--white);
        cursor: pointer;
        white-space: nowrap; /* Prevent text wrapping */
        padding: 0 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Responsive adjustments */
      @media screen and (max-width: 600px) {
        .search-container {
          max-width: none;
          width: 100%;
        }

        #searchBtn {
          padding: 0 0.5rem;
          min-width: 60px;
        }
      }

      /* Adjustments for very small screens */
      @media screen and (max-width: 320px) {
        .search-container {
          height: 36px; /* Slightly smaller for very small screens */
        }

        #searchInput,
        #searchBtn {
          line-height: 34px;
          font-size: 14px; /* Slightly smaller font for very small screens */
        }

        #searchBtn {
          padding: 0 0.4rem;
          min-width: 50px;
        }
      }

      /* Android-specific fixes */
      @media screen and (max-width: 600px) and (-webkit-min-device-pixel-ratio: 0) {
        #searchInput,
        #searchBtn {
          /* Ensure smooth edges on Android */
          -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
        }
      }

      .btn {
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        font-size: 0.9rem;
        white-space: nowrap;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn.active,
      .btn:active {
        background-color: var(--secondary-color);
      }

      .btn:hover {
        background-color: var(--secondary-color);
      }

      .btn:active {
        transform: scale(0.95);
      }

      .time-display {
        text-align: center;
        color: var(--white);
        font-size: 0.8rem;
        margin-bottom: 10px;
      }

      .playlist-sidebar {
        position: fixed;
        top: 0;
        right: -300px;
        width: 300px;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease-in-out;
        z-index: 1000;
        display: flex;
        flex-direction: column;
      }

      .playlist-sidebar.open {
        right: 0;
      }

      .sidebar-header {
        position: sticky;
        top: 0;
        background-color: var(--primary-color);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1001;
      }

      .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0px;
        padding-top: 0px;
      }

      .sidebar-content h2 {
        margin-bottom: 15px;
        color: var(--primary-color);
      }

      /* Ensure the content doesn't start under the header on mobile */
      @media (max-width: 768px) {
        .sidebar-content {
          padding-top: 0px;
        }
      }

      .sidebar-header h2 {
        margin: 0;
        color: var(--white);
      }

      .play-count {
        font-size: 0.8rem;
        color: var(--secondary-color);
        margin-bottom: 0.5rem; /* Space between play count and button */
      }

      #closePlaylistBtn {
        position: static;
        padding: 5px 10px;
        font-size: 0.8rem;
        background-color: var(--secondary-color);
        color: var(--white);
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #fullPlaylist {
        list-style-type: none;
        padding: 0;
      }

      #fullPlaylist li {
        display: flex;
        align-items: center;
        padding: 10px 5px;
        border-bottom: 1px solid #eee;
        cursor: move; /* Indicates item is movable */
        transition: background-color 0.2s ease;
      }

      .drag-handle {
        margin-right: 10px;
        color: #888;
        cursor: move;
      }

      #fullPlaylist li.dragging {
        opacity: 0.5;
        background-color: var(--secondary-color);
        color: var(--white);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      #fullPlaylist li:hover {
        background-color: #f0f0f0;
      }

      #fullPlaylist li.playing {
        background-color: var(--secondary-color);
        color: var(--white);
        font-weight: bold;
      }

      @media (max-width: 320px) {
  .playlist {
    grid-template-columns: 1fr;
  }

  .song {
    flex-direction: row;
    align-items: flex-start;
    text-align: center;
  }

  .song img {
    width: 60px;
    height: 60px;
    margin-right: 0.5rem;
  }

  .song-content {
    flex: 1;
  }

  .song .cover-artists,
  .song .song-title,
  .song .original-artists {
    -webkit-line-clamp: 2;
    line-clamp: 2;
    max-height: 2.4em;
  }

  .play-count {
    text-align: center;
    padding: 0.25rem 0;
  }
}

      @media (max-width: 480px) {
        .playlist {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.5rem;
        }

        .song {
          padding: 0.5rem;
        }

        .song img {
          width: 100%;
          height: auto;
        }

    .song .song-title {
    position: sticky;
    font-size: 1rem;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    max-height: 3em;
  }

  .song .cover-artists,
  .song .original-artists {
    position: sticky;
    font-size: 0.75rem;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    max-height: 2.4em;
  }

  .play-count {
    position: static
  }
}

      @media (max-width: 768px) {
        .playlist {
          grid-template-columns: repeat(2, 1fr);
        }

        .playlist-sidebar {
          width: 100%;
          right: -100%;
        }

        .volume-container {
          display: none;
        }

        .controls-container {
          flex-direction: column;
          align-items: stretch;
        }

        .search-container {
          max-width: none;
          margin-bottom: 0.5rem;
        }

        .btn {
          width: 100%;
        }

  .song-title {
    position: sticky;
    font-size: 1rem;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    max-height: 2.4em;
  }

  .cover-artists {
    position: sticky;
    font-size: 0.85rem;
    line-clamp: 1;
    -webkit-line-clamp: 1;
  }

  .original-artists {
    position: sticky;
    font-size: 0.75rem;
    line-clamp: 1;
    -webkit-line-clamp: 1;
  }

  .play-count {
    position: static;
    bottom: 0.5rem;
    left: 0.5rem;
    right: 0.5rem;
    padding-top: 0.5rem;
    font-size: 0.75rem;
    text-align: center;
  }
      }

      /* Medium-sized desktop */
  @media (min-width: 769px) and (max-width: 1024px) {
  .playlist {
    grid-template-columns: repeat(3, 1fr);
  }

  .song {
    padding: 0.5rem;
  }

  .song-content {
    gap: 0.3rem;
  }

  .song-title,
  .cover-artists,
  .original-artists {
    position: sticky;
    margin: 0.1rem 0;
    line-height: 1;
  }

  .song-title {
    font-size: 1rem;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    max-height: 2em;
  }

  .cover-artists,
  .original-artists {
    font-size: 0.80rem;
    line-clamp: 2;
    -webkit-line-clamp: 2;
  }

  .play-count {
    position: static;
    bottom: 0.5rem;
    left: 0.5rem;
    right: 0.5rem;
    padding-top: 0.5rem;
    font-size: 0.80rem;
    text-align: center;
  }
}

/* Large desktop */
@media (min-width: 1025px) {
  .playlist {
    grid-template-columns: repeat(5, 1fr);
  }

  .song {
    padding: 0.5rem;
  }

  .song-content {
    gap: 0.3rem;
  }

  .song-title {
    position: sticky;
    font-size: 1rem;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    max-height: 2.4em;
  }

  .cover-artists {
    position: sticky;
    font-size: 0.85rem;
    line-clamp: 1;
    -webkit-line-clamp: 1;
  }

  .original-artists {
    position: sticky;
    font-size: 0.75rem;
    line-clamp: 1;
    -webkit-line-clamp: 1;
  }

  .play-count {
    position: static;
    bottom: 0.5rem;
    left: 0.5rem;
    right: 0.5rem;
    padding-top: 0.5rem;
    font-size: 0.75rem;
    text-align: center;
  }
}

      
      /* Donate and Socials Modal Styles */
      .donate-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .donate-modal-content {
        background-color: rgba(255, 255, 255, 0.9);
        margin: 15% auto;
        padding: 20px;
        border-radius: 15px;
        width: 80%;
        max-width: 500px;
        text-align: center;
        display: flex;
        flex-direction: column;
      }

      .donate-modal h2 {
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .donate-modal .buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-grow: 1;
      }

      .donate-modal .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.3s ease;
        text-decoration: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 44px;
      }

      .donate-modal .btn:hover {
        transform: translateY(-3px);
      }

      .donate-modal .patreon-btn {
        background-color: #000000;
      }
      .donate-modal .donate-btn {
        background-color: #33ce33;
      }
      .donate-modal .discord-btn {
        background-color: #7289da;
      }
      .donate-modal .youtube-btn {
        background-color: #ff0000;
      }
      .donate-modal .tiktok-btn {
        background-color: #f050a9;
      }
      .donate-modal .close-btn {
        background-color: var(--primary-color);
        margin-top: 1rem;
      }

      .modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        width: 100%;
      }

      .donation-message {
        font-size: 0.9rem;
        color: #666;
        text-align: right;
        margin-left: 1rem;
        flex-grow: 1;
      }

      /* Responsive adjustments */
      @media (max-width: 480px) {
        .modal-footer {
          flex-direction: column-reverse;
          align-items: stretch;
        }

        .donation-message {
          text-align: center;
          margin-left: 0;
          margin-bottom: 1rem;
        }

        .donate-modal .close-btn {
          width: 100%;
        }
      }

      /* Playlist Modal Styles */
      .playlist-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .playlist-modal-content {
        background-color: var(--white);
        margin: 15% auto;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 80vh;
        overflow-y: auto;
      }

      .playlist-modal-content h2 {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        font-family: "Orbitron", sans-serif;
        text-align: center; /* Center the "Your Playlists" header */
      }

      #playlistsList {
        list-style-type: none;
        padding: 0;
        margin-bottom: 0.5rem;
        max-height: 60vh;
        overflow-y: auto;
      }

      #playlistsList li {
        background-color: var(--white);
        border: 1px solid var(--gray);
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
      }

      .playlist-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1rem;
      }

      .playlist-header h3 {
        margin: 0 0 1rem 0;
        text-align: center;
      }

      .playlist-controls {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.75rem;
        width: 100%;
      }

      .play-playlist-btn,
      .toggle-songs-btn,
      .delete-playlist-btn {
        padding: 0.5rem;
        font-size: 0.9rem;
        flex: 1 1 30%;
        min-width: 100px;
        max-width: 150px;
        margin: 0.25rem;
      }

      .delete-playlist-btn {
        padding: 0.4rem;
        font-size: 0.8rem;
        flex: 0 1 auto;
        min-width: 100px;
        max-width: 120px;
        margin: 0;
        background-color: #e74c3c; /* Keep delete button red */
      }

      .delete-playlist-btn:hover {
        background-color: #c0392b;
      }

      .playlist-songs {
        margin-top: 0.5rem;
        padding-left: 0;
      }

      .playlist-songs li {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--gray);
        text-align: center;
      }

      .playlist-songs li:last-child {
        border-bottom: none;
      }

      .delete-song-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.5rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 0.5rem;
        width: 80%;
        max-width: 200px;
        font-size: 0.9rem;
      }

      .delete-song-btn:hover {
        background-color: #c0392b;
      }

      /* Media Player Fix */
      .player-container {
        padding-top: 0.1rem; /* Increase top padding to make room for the hide button */
      }

      .toggle-player-btn {
        position: absolute;
        top: -25px; /* Adjust this value to position the button correctly */
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 15px 15px 0 0;
        padding: 5px 20px;
        cursor: pointer;
        font-size: 0.8rem;
        z-index: 10;
      }

      .song-info {
        margin-top: 0.5rem; /* Add some top margin to the song info to separate it from the hide button */
      }

      /* Responsive adjustments */
      @media (max-width: 480px) {
        .playlist-modal-content {
          padding: 1.5rem;
          margin: 10% auto;
        }

        .play-playlist-btn,
        .toggle-songs-btn,
        .delete-playlist-btn {
          flex: 1 1 100%;
          max-width: none;
          width: 100%;
          margin: 0.25rem 0;
        }
      }

      .delete-playlist-btn {
        order: 3; /* Move delete button to the bottom on small screens */
      }

      .delete-song-btn:hover,
      .delete-playlist-btn:hover {
        background-color: #c0392b;
      }

      .modal .btn {
        margin-top: 1rem;
      }

      .playlist-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
      }

      .add-to-playlist-btn {
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: 15px;
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        margin-top: 0.5rem;
        flex-grow: 1;
        margin: 0 0.5rem;
      }

      .add-to-playlist-btn:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
      }

      .song {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .toggle-player-btn {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 15px 15px 0 0;
        padding: 5px 20px;
        cursor: pointer;
        font-size: 0.8rem;
        z-index: 10;
      }

      .player-content {
        transition: opacity 0.3s ease-out;
      }

      .player-container.hidden .player-content {
        opacity: 0;
        pointer-events: none;
      }

      /* Homescreen Button Styles */
      #addToHomeScreenBtn {
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        font-size: 0.9rem;
        white-space: nowrap;
        display: none;
        height: 36px;
        align-items: center;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      #addToHomeScreenBtn:hover {
        background-color: var(--secondary-color);
      }

      #addToHomeScreenBtn:active,
      #addToHomeScreenBtn.active {
        transform: scale(0.95);
      }

      @media (hover: hover) {
        #addToHomeScreenBtn:hover {
          background-color: var(--secondary-color);
        }
      }

      /* Font alignment */
      .btn i {
        margin-right: 0.3rem;
      }

      /* No Zoom on Mobile when Using Search Bar */
      input[type="text"],
      input[type="search"],
      input[type="submit"],
      button {
        font-size: 16px; /* Minimum font size to prevent zoom on iOS */
      }

      @media screen and (max-width: 768px) {
        body {
          -webkit-text-size-adjust: 100%;
        }
      }
      /* Drag and Drop for Show Playlist Reorganization Style */
      #fullPlaylist li.dragging {
        opacity: 0.5;
        background-color: var(--secondary-color);
      }

      /* Main Playlist Spacer */
      .spacer {
        display: inline-block;
        width: 20px; /* Adjust this value to match the width of your drag handle */
      }

      #fullPlaylist li {
        display: flex;
        align-items: center;
      }

      .drag-handle,
      .spacer {
        margin-right: 10px;
      }

      .drag-handle {
        cursor: move;
      }

      .spacer {
        cursor: default;
      }

      #dragDropInfo {
        font-size: 0.9em;
        color: #333;
        border-left: 3px solid #3498db;
      }

      #dragDropInfo i {
        color: #3498db;
        margin-right: 5px;
      }

      .playlist-songs li {
        cursor: move;
      }
      .playlist-songs li.dragging {
        opacity: 0.5;
        background-color: var(--secondary-color);
      }
      .drag-handle {
        cursor: move;
        padding-right: 10px;
      }

      #splashScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #fce2d9;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
      }

      .splash-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80%;
        max-width: 512px;
      }

      #splashScreen img {
        max-width: 100%;
        height: auto;
        transition: transform 4.71s ease-in-out, opacity 0.5s ease-out;
      }

      #enterSiteBtn {
        margin-top: 20px;
        font-size: 1.2rem;
        padding: 10px 20px;
        background-color: #ffffff;
        color: rgb(0, 0, 0);
        border: 2px solid rgb(0, 0, 0);
        border-radius: 25px;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease,
          opacity 0.3s ease;
        text-align: center;
        max-width: 200px;
        width: 80%;
        height: 44px;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        position: relative;
      }

      #enterSiteBtn:hover {
        background-color: rgb(0, 0, 0);
        color: #fce2d9;
      }

      #enterSiteBtn.hidden {
        opacity: 0;
        pointer-events: none;
      }

      #enterSiteBtn.fade-out {
        animation: fadeOut 1s ease-out forwards;
        pointer-events: none;
      }

      @keyframes fadeOut {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      @keyframes fadeOutRotate {
        0% {
          opacity: 1;
          transform: rotate(0deg);
        }
        100% {
          opacity: 0;
          transform: rotate(360deg);
        }
      }

      /* Media queries for responsive adjustments */
      @media screen and (max-width: 320px) {
        #enterSiteBtn {
          font-size: 0.9rem;
          padding: 6px 12px;
          max-width: 140px;
          height: 36px;
        }
      }

      @media screen and (max-width: 480px) {
        #enterSiteBtn {
          font-size: 1rem;
          padding: 8px 16px;
          max-width: 160px;
          height: 38px;
        }
      }

      @media screen and (max-width: 768px) {
        #enterSiteBtn {
          font-size: 1.1rem;
          padding: 8px 16px;
          max-width: 180px;
          height: 40px;
        }
      }

      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 2000;
      }

      .notification.show {
        opacity: 1;
      }

      .notification.info {
        background-color: #2196f3;
      }

      .notification.error {
        background-color: #f44336;
      }

      .add-to-playlist-btn.added {
        background-color: #4caf50;
        color: white;
        transition: background-color 0.3s ease;
      }

      @keyframes marquee-scroll {
        0%,
        10% {
          transform: translateX(0);
        }
        45%,
        55% {
          transform: translateX(calc(-100% + 300px));
        }
        90%,
        100% {
          transform: translateX(0);
        }
      }

      .scroll-container {
        width: 100%;
        overflow: hidden;
      }

      #currentSong {
        display: inline-block;
        white-space: nowrap;
        padding-left: 20px;
        padding-right: 20px;
        animation: marquee-scroll 20s linear infinite;
      }

      #currentSong:hover {
        animation-play-state: paused;
      }

      .rename-playlist-btn {
        cursor: pointer;
        margin-left: 5px;
        font-size: 0.8em;
        color: #3498db;
      }

      .rename-playlist-btn:hover {
        color: #2980b9;
      }

      .playlist-name {
        display: inline-block;
        min-width: 50px;
        padding: 2px 5px;
        border: 1px solid transparent;
        border-radius: 3px;
      }

      .playlist-name:focus {
        outline: none;
        border-color: #3498db;
        background-color: #fff;
      }

      .playlist-name[contenteditable="true"] {
        cursor: text;
      }

      .song-count {
        margin-left: 5px;
        font-size: 0.8em;
        color: #7f8c8d;
      }

      /* Total Plays Ticker Styles */
      #mainHeader {
        margin-bottom: 10px; /* Reduce bottom margin */
      }

      #totalPlayCountContainer {
        display: inline-block;
        padding: 10px 20px;
        text-align: center;
        margin: 10px 0 20px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      #totalPlayCount {
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        text-shadow: 4px 4px 4px #cfcfcf;
        color: #3498db;
        letter-spacing: 0.05em;
        font-size: 1.5rem;
        line-height: 1.3;
        margin-bottom: 5px;
        white-space: nowrap;
      }

      .ticker-transition {
        transition: opacity 0.5s ease-in-out;
      }

      .ticker-hidden {
        opacity: 0;
      }

      @media (max-width: 768px) {
        #totalPlayCount {
          font-size: 1rem;
        }
      }

      @media (max-width: 480px) {
        #totalPlayCount {
          font-size: 0.9rem;
          letter-spacing: 1px;
        }
      }

      @media (max-width: 480px) {
        #totalPlayCountContainer {
          margin: 5px auto 15px;
        }
      }

      /* Increase size for tablets */
      @media (max-width: 768px) {
        #totalPlayCount {
          font-size: 1.8rem;
        }
        #totalPlayCountContainer {
          margin: 8px auto 15px;
        }
      }

      /* Further increase size for mobile */
      @media (max-width: 480px) {
        #totalPlayCount {
          font-size: 1.5rem;
          letter-spacing: 0.03em;
        }
        #totalPlayCountContainer {
          margin: 5px auto 10px;
        }
        #mainHeader {
          margin-bottom: 0px; /* Reduce margin below the header for mobile */
        }
      }

      /* Android Optimization Styles */
      @media screen and (max-width: 600px) {
        .simplified-layout .playlist {
          display: flex;
          flex-direction: column;
        }

        .simplified-layout .song {
          margin-bottom: 10px;
        }

        .simplified-layout .player-container {
          bottom: 0;
          left: 0;
          width: 100%;
          border-radius: 0;
        }
      }

      .remove-from-playlist-btn {
        background-color: #e74c3c;
        color: var(--white);
        border: none;
        border-radius: 15px;
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        margin-top: 0.5rem;
        flex-grow: 1;
        margin: 0 0.5rem;
      }

      .remove-from-playlist-btn:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
      }

      .remove-from-playlist-btn:active {
        transform: scale(0.95);
      }

      /* Adjust the layout for custom playlist view */
      .song .song-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
      }

      .song .song-controls .move-btn {
        font-size: 1rem;
        padding: 2px 5px;
        margin: 0 2px;
      }

      /* Responsive design for smaller screens */
      @media (max-width: 768px) {
        .song .song-controls {
          flex-direction: column;
          align-items: stretch;
        }

        .remove-from-playlist-btn,
        .song .song-controls .move-btn {
          margin-top: 5px;
          width: 100%;
        }
      }

      /* Sync Options Styles */
      #syncOptionsBtn,
      #refreshPlaylistsBtn {
        margin-bottom: 0.1rem; /* Reduce bottom margin */
        width: 100%; /* Make buttons full width */
      }

      #syncOptionsModal {
        display: none;
      }

      #syncOptionsModal .playlist-modal-content {
        max-width: 400px;
      }

      #syncDeviceIdInput {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
      }

      #deviceIdDisplay,
      #syncInstructions {
        margin-bottom: 1rem;
      }

      #deviceIdContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1rem;
      }

      #deviceIdDisplay {
        text-align: center;
        margin-bottom: 0.5rem;
        width: 100%;
      }

      #copyDeviceIdBtn {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      /* Play Count Update Styles */
      .play-count {
        transition: opacity 0.5s ease-in-out;
      }

      .ticker-transition {
        transition: opacity 0.5s ease-in-out;
      }

      .ticker-hidden {
        opacity: 0;
      }

      #approximateUsers {
        font-family: 'Roboto', sans-serif;
        text-shadow: 2px 2px 2px #c7c7c7;
        display: block;
        font-size: 1rem;
        color: var(--primary-color);
        margin-top: 5px;
        white-space: nowrap;
      }

      @media (max-width: 768px) {
        #totalPlayCount {
          font-size: 1.2rem;
        }
        #approximateUsers {
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        #totalPlayCount {
          font-size: 1rem;
        }
        #approximateUsers {
          font-size: 0.8rem;
        }
        #totalPlayCountContainer {
          margin: 5px auto 15px;
          padding: 8px 15px;
        }
      }

      /* Lyrics Modal Styles */
      .modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
  position: relative;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 20px;
  border-radius: 10px;
  overflow: hidden;
  max-width: 800px;
  width: 90%;
  margin: 20px auto;
}

.player-container {
  z-index: 1000;
}

.lyrics-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-size: cover;
  background-position: center;
  opacity: 0.5;
  z-index: 0;
}

#lyricsSongTitle,
#lyricsContainer,
#closeLyricsBtn {
  position: relative;
  z-index: 1;
}

#lyricsSongTitle {
  font-size: 1.5em;
  margin-bottom: 15px;
  text-align: center;
}

#lyricsContainer {
  max-height: 50vh;
  overflow-y: auto;
  padding: 10px;
  background-color: rgba(255, 255, 255, 0.7);
  border-radius: 5px;
  margin-bottom: 20px;
}

#lyricsContent {
  white-space: pre-wrap;
  font-family: Arial, sans-serif;
  line-height: 1.6;
  color: #000;
}

#lyricsContent p {
  margin: 0;
  padding: 2px 0;
  transition: color 0.3s, font-weight 0.3s;
}

#lyricsContent p.active {
  color: var(--primary-color);
  font-weight: bold;
}

#closeLyricsBtn {
  display: block;
  margin: 0 auto;
  padding: 10px 20px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s;
}

#closeLyricsBtn:hover {
  background-color: var(--secondary-color);
}

#lyricsPlayerControls {
    display: none;
}

@media (max-width: 600px) {
  .modal-content {
    padding: 15px;
  }

  #lyricsContainer {
    max-height: 40vh;
  }
}

.patrick-hand-sc-regular {
  font-family: "Patrick Hand SC", cursive;
  font-weight: 400;
  font-style: normal;
}


    </style>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
  </head>
  <body>
    <div id="splashScreen">
      <div class="splash-content">
        <img src="./splash-icon-512x512.png" alt="FWMC-AI RADIO" />
        <button id="enterSiteBtn" class="btn" data-default-text="Enter Site">
          Enter Site
        </button>
      </div>
    </div>

    <audio id="openSound" preload="auto">
      <source src="./audio/app-open-sound.mp3" type="audio/mpeg" />
    </audio>

    <header id="mainHeader" style="cursor: pointer">
      <img src="./images/header-logo.png" alt="FWMC-AI RADIO" id="headerLogo">
    </header>
    <div id="totalPlayCountContainer">
      <span id="totalPlayCount"></span>
      <span id="approximateUsers"></span>
    </div>

    <!-- Controls container -->
    <div class="controls-container">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search songs..." />
        <button id="searchBtn" class="btn">Search</button>
      </div>
      <button id="addToHomeScreenBtn" class="btn" style="display: none">
        Add to Home Screen
      </button>
      <button id="shuffleBtn" class="btn">Shuffle</button>
      <button id="showPlaylistBtn" class="btn">Show Playlist</button>
      <button id="backToMainBtn" class="btn" style="display: none">
        Back to Main Playlist
      </button>
      <button id="createPlaylistBtn" class="btn">
        <i class="fas fa-plus"></i> Create Playlist
      </button>
      <button id="viewPlaylistsBtn" class="btn">
        <i class="fas fa-list"></i> View Playlists
      </button>
      <button id="showDonateSocialsBtn" class="btn">
        Donate &amp; Socials
      </button>
    </div>

    <!-- Main playlist container -->
    <div class="playlist" id="playlist">
      <!-- Songs will be dynamically added here -->
    </div>

    <!-- Audio player container -->
    <div class="player-container">
      <button id="togglePlayerBtn" class="toggle-player-btn">Hide</button>
      <div class="player-content">
        <div class="song-info">
          <div class="scroll-container">
            <p id="currentSong">No song playing</p>
          </div>
        </div>
        <div class="progress-container" id="progressContainer">
          <div id="progressBar"></div>
        </div>
        <div class="time-display">
          <span id="currentTime">0:00</span> /
          <span id="totalDuration">0:00</span>
        </div>
        <div class="player-controls">
          <button
            id="skip10BackBtn"
            class="control-btn"
            title="Skip 10 seconds back"
          >
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path
                fill="currentColor"
                d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"
              />
            </svg>
          </button>
          <button id="prevBtn" class="control-btn">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
            </svg>
          </button>
          <button id="playPauseBtn" class="control-btn">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M8 5v14l11-7z" />
            </svg>
          </button>
          <button id="nextBtn" class="control-btn">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path
                fill="currentColor"
                d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"
              />
            </svg>
          </button>
          <button
            id="skip10AheadBtn"
            class="control-btn"
            title="Skip 10 seconds ahead"
          >
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path
                fill="currentColor"
                d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"
              />
            </svg>
          </button>
          <button id="repeatBtn" class="control-btn" title="Repeat: Off">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path
                fill="currentColor"
                d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"
              />
            </svg>
          </button>
          <button id="lyricsBtn" class="control-btn" title="Show Lyrics">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path
                fill="currentColor"
                d="M3 20h18v-2H3v2zm0-7h18v-2H3v2zm0-7h18V4H3v2z"
              />
            </svg>
          </button>
          <div class="volume-container">
            <input
              type="range"
              id="volumeControl"
              min="0"
              max="1"
              step="0.1"
              value="1"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Lyrics Modal -->
    <div id="lyricsModal" class="modal">
        <div class="modal-content">
            <div class="lyrics-background"></div>
            <h2 id="lyricsSongTitle"></h2>
            <div id="lyricsContainer">
                <pre id="lyricsContent"></pre>
            </div>
            <div id="lyricsPlayerControls" class="player-controls">
                <!-- Media player controls will be transferred here -->
            </div>
            <button id="closeLyricsBtn" class="btn">Close Lyrics</button>
        </div>
    </div>

    <!-- Playlist sidebar -->
    <div id="playlistSidebar" class="playlist-sidebar">
      <div class="sidebar-header">
        <h2>Full Playlist</h2>
        <button id="closePlaylistBtn" class="btn">Close</button>
      </div>
      <div class="sidebar-content">
        <div
          id="dragDropInfo"
          style="
            display: none;
            padding: 10px;
            background-color: #f0f0f0;
            margin-bottom: 10px;
            border-radius: 5px;
          "
        >
          <p>
            <i class="fas fa-info-circle"></i> Tip: You can drag and drop songs
            to reorder this playlist.
          </p>
        </div>
        <ul id="fullPlaylist"></ul>
      </div>
    </div>

    <!-- Create Playlist Modal -->
    <div id="createPlaylistModal" class="playlist-modal">
      <div class="playlist-modal-content">
        <h2>Create New Playlist</h2>
        <input
          type="text"
          id="newPlaylistName"
          placeholder="Enter playlist name"
        />
        <button id="saveNewPlaylistBtn" class="btn">
          <i class="fas fa-save"></i> Save Playlist
        </button>
        <button id="closeCreatePlaylistModalBtn" class="btn">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <!-- View Playlists Modal -->
    <div id="viewPlaylistsModal" class="playlist-modal">
      <div class="playlist-modal-content">
        <h2>Your Playlists</h2>
        <button id="syncOptionsBtn" class="btn">Sync Options</button>
        <button id="refreshPlaylistsBtn" class="btn">
          <i class="fas fa-sync-alt"></i> Refresh Playlists
        </button>
        <ul id="playlistsList"></ul>
        <button id="closeViewPlaylistsModalBtn" class="btn">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <!-- New Sync Options Modal -->
    <div id="syncOptionsModal" class="playlist-modal">
      <div class="playlist-modal-content">
        <h2>Sync Options</h2>
        <div id="deviceIdContainer">
          <span id="deviceIdDisplay"></span>
          <button id="copyDeviceIdBtn" class="btn">
            <i class="fas fa-copy"></i> Copy Device ID
          </button>
        </div>
        <div id="syncInstructions"></div>
        <input
          type="text"
          id="syncDeviceIdInput"
          placeholder="Enter Device ID (e.g., abc123)"
          maxlength="9"
        />
        <button id="syncPlaylistsBtn" class="btn">Sync Playlists</button>
        <button id="closeSyncOptionsModalBtn" class="btn">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="addToPlaylistModal" class="playlist-modal">
      <div class="playlist-modal-content">
        <h2>Add to Playlist</h2>
        <select id="playlistSelect"></select>
        <button id="confirmAddToPlaylist" class="btn">
          <i class="fas fa-plus"></i> Add
        </button>
        <button id="closeAddToPlaylistModalBtn" class="btn">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>

    <!-- Modal HTML for Donate and Socials Buttons -->
    <div id="donateSocialsModal" class="donate-modal">
      <div class="donate-modal-content">
        <h2>Donate &amp; Socials</h2>
        <div class="buttons">
          <a
            href="https://www.patreon.com/fwmc_ai"
            target="_blank"
            class="btn patreon-btn"
            >Support on Patreon</a
          >
          <a
            href="https://cash.app/$fwmcai"
            target="_blank"
            class="btn donate-btn"
            >Donate on CashApp</a
          >
          <a
            href="https://discord.gg/zp7TunBVc7"
            target="_blank"
            class="btn discord-btn"
            >Join our Discord</a
          >
          <a
            href="https://www.youtube.com/@HololiveAI"
            target="_blank"
            class="btn youtube-btn"
            >Subscribe on YouTube</a
          >
          <a
            href="https://www.tiktok.com/@fwmc.ai"
            target="_blank"
            class="btn tiktok-btn"
            >Follow on TikTok</a
          >
        </div>
        <div class="modal-footer">
          <button id="closeModalBtn" class="btn close-btn">Close</button>
          <p class="donation-message">
            Donations help support site costs &amp; future development of
            FWMC-AI RADIO. Thanks for your support!
          </p>
        </div>
      </div>
    </div>

    <noscript>
      <p>
        This app requires JavaScript to function. Please enable JavaScript in
        your browser settings.
      </p>
    </noscript>

    <script>
      const isDevelopment = false; // Set this to true for local testing
      console.log("Script is running");
      if (isDevelopment) console.log("Obfuscated config exists:", !!window.obfuscatedFirebaseConfig);

      // Version Check
      function checkVersion() {
        fetch("version.json?nocache=" + new Date().getTime())
          .then((response) => {
            if (!response.ok) {
              throw new Error("Version file not found");
            }
            return response.json();
          })
          .then((data) => {
            const currentVersion = localStorage.getItem("appVersion");
            if (currentVersion !== data.version) {
              // Preserve the device ID
              const deviceId = localStorage.getItem("deviceId");

              // Clear localStorage to force reload of all resources
              localStorage.clear();

              // Restore the device ID
              if (deviceId) {
                localStorage.setItem("deviceId", deviceId);
              }

              // Store the new version in localStorage
              localStorage.setItem("appVersion", data.version);

              // Optionally, you might want to preserve user playlists as well
              const userPlaylists = localStorage.getItem("userPlaylists");
              if (userPlaylists) {
                localStorage.setItem("userPlaylists", userPlaylists);
              }

              alert("A new version is available. The page will now refresh.");
              window.location.reload(true);
            }
          })
          .catch((error) => {
            console.error("Error checking version:", error);
            // Optionally, set a default version if the file can't be loaded
            // localStorage.setItem('appVersion', '1.0.0');
          });
      }

      // Cache Busting
      function cacheBustAssets() {
        const version = localStorage.getItem("appVersion") || "1.3.8";
        const scripts = document.querySelectorAll("script[src]");
        const links = document.querySelectorAll('link[rel="stylesheet"][href]');

        scripts.forEach((script) => {
          script.src = script.src.split("?")[0] + "?v=" + version;
        });
        links.forEach((link) => {
          link.href = link.href.split("?")[0] + "?v=" + version;
        });
      }

// Firebase initialization
(function initializeFirebase() {
  console.log('Attempting to initialize Firebase...');
  
  if (!window.obfuscatedFirebaseConfig) {
    console.error("Obfuscated Firebase config not found");
    return;
  }

  if (!window.decodeAppConfig) {
    console.error("decodeAppConfig function not found");
    return;
  }

  if (window.firebaseInitialized) {
    console.log('Firebase already initialized');
    return;
  }

  try {
    const decodedConfig = window.decodeAppConfig(window.obfuscatedFirebaseConfig);
    console.log('Firebase config loaded successfully');

    if (!firebase.apps.length) {
      firebase.initializeApp(decodedConfig);
      window.firebaseInitialized = true;
      console.log('Firebase initialized successfully');
    } else {
      console.log('Firebase app already exists');
    }

    window.database = firebase.database();
    console.log('Firebase database reference created');

    // Try to enable offline persistence
    if (firebase.database.Persistence) {
      firebase.database()
        .setPersistence(firebase.database.Persistence.LOCAL)
        .then(() => console.log('Offline persistence enabled'))
        .catch((error) => console.warn('Failed to enable offline persistence:', error));
    } else {
      console.warn('Firebase database Persistence not available');
    }

    // Explicitly connect to Firebase servers
    firebase.database().goOnline();
    console.log('Explicitly connected to Firebase servers');

    // Check connection status
    const connectedRef = window.database.ref(".info/connected");
    connectedRef.on("value", (snap) => {
      console.log('Connection status:', snap.val() ? 'connected' : 'disconnected');
    });

    // Handle connection state changes
    window.database.ref(".info/connected").on("value", (snapshot) => {
      console.log(snapshot.val() ? "App is online" : "App is offline");
    });

  } catch (error) {
    console.error("Error during Firebase initialization:", error);
  }
})();

      // Playlist and audio player setup
      const playlist = [
        // Playlist items here
        // New Songs Here - This Will Ensure They Are Shown First
        {
          id: "strangeratthetable",
          title: "shiori novella, koseki bijou - stranger at the table (chance the rapper, jeremih)",
          file: "./audio/strangeratthetable.mp3",
          cover: "./images/strangeratthetable.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/strangeratthetable.txt",
        },

        {
          id: "snowedin",
          title: "amelia watson, gawr gura - snowed in (chance the rapper, jeremih)",
          file: "./audio/snowedin.mp3",
          cover: "./images/snowedin.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/snowedin.txt",
        },

        {
          id: "littlesaplingsstudio",
          title: "Ceres Fauna - Little Saplings [Studio Version] (FWMC-AI Original Song)",
          file: "./audio/littlesaplingsstudio.mp3",
          cover: "./images/littlesaplingsstudio.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/littlesaplings.txt",
        },

        {
          id: "littlesaplings",
          title: "Ceres Fauna - Little Saplings [Karaoke Version] (FWMC-AI Original Song)",
          file: "./audio/littlesaplings.mp3",
          cover: "./images/littlesaplings.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/littlesaplings.txt",
        },

        {
          id: "infwmcwetrust",
          title: "FUWAMOCO - In FWMC We Trust (FWMC-AI Original Song)",
          file: "./audio/infwmcwetrust.mp3",
          cover: "./images/infwmcwetrust.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/infwmcwetrust.txt",
        },

        {
          id: "sugar",
          title: "shiori novella - sugar (brockhampton, davina michelle)",
          file: "./audio/sugar.mp3",
          cover: "./images/sugar.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sugar.txt",
        },

        {
          id: "conceited",
          title: "ironmouse - conceited (lil uzi vert)",
          file: "./audio/conceited.mp3",
          cover: "./images/conceited.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/conceited.txt",
        },

        {
          id: "chillbae",
          title: "mococo abyssgard - chill bae (lil uzi vert)",
          file: "./audio/chillbae.mp3",
          cover: "./images/chillbae.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/chillbae.txt",
        },

        {
          id: "burningdesires",
          title: "koseki bijou - burning desires (burnice white, zenless zone zero)",
          file: "./audio/burningdesires.mp3",
          cover: "./images/burningdesires.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/burningdesires.txt",
        },

        {
          id: "void",
          title: "mococo abyssgard - void (juice wrld, fwmc-ai x leo_frixi collab)",
          file: "./audio/void.mp3",
          cover: "./images/void.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/void.txt",
        },

        {
          id: "zeze",
          title: "gawr gura, ironmouse, mococo abyssgard - zeze (travis scott, kodak black, offset)",
          file: "./audio/zeze.mp3",
          cover: "./images/zeze.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/zeze.txt",
        },

        {
          id: "sugarcube",
          title: "minato aqua -  [as the sugar cube floats, fleeting in time] (zhu juan, zenless zone zero)",
          file: "./audio/sugarcube.mp3",
          cover: "./images/sugarcube.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sugarcube.txt",
        },

        {
          id: "dmpb",
          title: "mori calliope - drugs, money, pussy, & beer (yung gravy)",
          file: "./audio/DMPB.mp3",
          cover: "./images/dmpb.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/dmpb.txt",
        },

        {
          id: "hbcd",
          title: "koseki bijou, noko shikanoko - hugs, bunnies, cookies, & deer (yung gravy)",
          file: "./audio/HBCD.mp3",
          cover: "./images/hbcd.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/hbcd.txt",
        },

        {
          id: "sharksgottabite",
          title: "gawr gura - shark's gotta bite (ellen joe, zenless zone zero)",
          file: "./audio/sharksgottabite.mp3",
          cover: "./images/sharksgottabite.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sharksgottabite.txt",
        },

        {
          id: "loveyoumore",
          title: "ironmouse, nanashi mumei, mococo abyssgard - love you more (earthgang, t-pain)",
          file: "./audio/loveyoumore.mp3",
          cover: "./images/loveyoumore.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/loveyoumore.txt",
        },

        {
          id: "sayso",
          title: "gawr gura - say so (doja cat, cover by saint)",
          file: "./audio/sayso.mp3",
          cover: "./images/sayso.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sayso.txt",
        },

        {
          id: "dieforyou",
          title: "ouro kronii - die for you (the weeknd, cover by saint)",
          file: "./audio/dieforyou.mp3",
          cover: "./images/dieforyou.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/dieforyou.txt",
        },

        {
          id: "vanished",
          title: "takanshi kiara - vanished (crystal castles, van she)",
          file: "./audio/vanished.mp3",
          cover: "./images/vanished.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/vanished.txt",
        },

        {
          id: "selfcontrol",
          title: "holomyth - self control (frank ocean, annie dang)",
          file: "./audio/selfcontrol.mp3",
          cover: "./images/selfcontrol.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/selfcontrol.txt",
        },

        {
          id: "pinkwhite",
          title: "fuwamoco - pink + white (frank ocean, remi wolf)",
          file: "./audio/pinkwhite.mp3",
          cover: "./images/pinkwhite.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/pinkwhite.txt",
          syncedLyrics: "./lyrics/pinkwhite-synced.txt",
        },

        {
          id: "needafavor",
          title:
            "mori calliope - need a favor (jelly roll, brenna bone)",
          file: "./audio/needafavor.mp3",
          cover: "./images/needafavor.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/needafavor.txt",
        },
        {
          id: "saveme",
          title:
            "takanashi kiara - save me (jelly roll, kearstin clark)",
          file: "./audio/saveme.mp3",
          cover: "./images/saveme.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/saveme.txt",
        },
        {
          id: "bubbly",
          title:
            "nanashi mumei, gawr gura, fuwamoco - bubbly (young thug, travis scott, drake)",
          file: "./audio/bubbly.mp3",
          cover: "./images/bubbly.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/bubbly.txt",
        },
        {
          id: "bautothebone",
          title:
            "fuwamoco - bau to the bone // feeling good (george thorogood, nina simone, gab lobo)",
          file: "./audio/bautothebone.mp3",
          cover: "./images/bautothebone.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/bautothebone.txt",
        },
        {
          id: "airplanept2",
          title:
            "takanashi kiara - airplane pt. 2 (bts, shimmeringrain, fwmc-ai x leo_frixi collab)",
          file: "./audio/airplanept2.mp3",
          cover: "./images/airplanept2.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/airplanept2.txt",
          syncedLyrics: "./lyrics/airplanept2-synced.txt",
        },
        {
          id: "dieforparty",
          title: "dokibird - die for the party (lecrae, cover by leo_frixi)",
          file: "./audio/dieforparty.mp3",
          cover: "./images/dieforparty.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/diefortheparty.txt",
          syncedLyrics: "./lyrics/diefortheparty-synced.txt",
        },
        {
          id: "dirt",
          title: "gawr gura - dirt (bones) ",
          file: "./audio/dirt.mp3",
          cover: "./images/dirt.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/dirt.txt",
        },
        {
          id: "dearmama",
          title: "fuwamoco, koseki bijou - dear mama puppy (2pac) ",
          file: "./audio/dearmama.mp3",
          cover: "./images/dearmama.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/dearmama.txt",
        },
        {
          id: "beam",
          title:
            "nanashi mumei, gawr gura, ironmouse, filian - beam (rich brian, playboi carti) ",
          file: "./audio/beam.mp3",
          cover: "./images/beam.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/beam.txt",
        },
        {
          id: "anacondas",
          title:
            "mococo abyssgard - anacondas (juice wrld, fwmc-ai x leo_frixi collab) ",
          file: "./audio/anacondas.mp3",
          cover: "./images/anacondas.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/anacondas.txt",
        },
        {
          id: "lastnightfuwa",
          title:
            "fuwawa abyssgard - last night (morgan wallen, carah) ",
          file: "./audio/lastnight.mp3",
          cover: "./images/lastnight.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/lastnight.txt",
        },
        {
          id: "todaysmashingpumpkins",
          title:
            "watson amelia - today (smashing pumpkins, first to eleven) ",
          file: "./audio/today.mp3",
          cover: "./images/today.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/today.txt",
        },
        {
          id: "wakemeupsept",
          title:
            "watson amelia - wake me up when september ends (green day, vivoree) ",
          file: "./audio/wakemeupsept.mp3",
          cover: "./images/wakemeupsept.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/wakemeupsept.txt",
        },
        {
          id: "agorahills",
          title: "fuwamoco - agora hills (doja cat)",
          file: "./audio/agorahills.mp3",
          cover: "./images/agorahills.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/agorahills.txt",
        },
        {
          id: "allred",
          title: "nanashi mumei - all red (playboi carti)",
          file: "./audio/allred.mp3",
          cover: "./images/allred.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/allred.txt",
        },
        {
          id: "watchtheparty",
          title: "fuwamoco - watch the party die (kendrick lamar)",
          file: "./audio/watchtheparty.mp3",
          cover: "./images/watchtheparty.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/watchtheparty.txt",
        },
        {
          id: "seeyouagain",
          title:
            "minato aqua, a-chan, mococo abyssgard, elizabeth rose bloodflame - see you again (wiz khalifa, charlie puth, chris brown, tyga, fwmc-ai x leo_frixi collab)",
          file: "./audio/seeyouagain.mp3",
          cover: "./images/seeyouagain.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/seeyouagain.txt",
        },
        {
          id: "lithonia",
          title: "filian - lithonia (childish gambino)",
          file: "./audio/lithonia.mp3",
          cover: "./images/lithonia.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/lithonia.txt",
        },
        {
          id: "allthestars",
          title:
            "shiori novella, fuwamoco - all the stars (sza, kendrick lamar, jorja smith)",
          file: "./audio/allthestars.mp3",
          cover: "./images/allthestars.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/allthestars.txt",
        },
        {
          id: "crush",
          title: "fuwamoco - crush (tessa violet)",
          file: "./audio/crush.mp3",
          cover: "./images/crush.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/crush.txt",
        },
        {
          id: "bestperson",
          title:
            "gawr gura, hakos baelz - best person you know // feral rat anthem (lowertown x hospital bracelets)",
          file: "./audio/bestperson.mp3",
          cover: "./images/bestperson.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/bestperson.txt",
        },
        {
          id: "goosebumps",
          title:
            "gawr gura, fuwamoco - goosebumps (travis scott, kendrick lamar)",
          file: "./audio/goosebumps.mp3",
          cover: "./images/goosebumps.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/goosebumps.txt",
        },
        {
          id: "daynnite",
          title:
            "gawr gura, mococo abyssgard, elizabeth rose bloodflame - day 'n' nite (kid cudi, l-fresh the lion)",
          file: "./audio/daynnite.mp3",
          cover: "./images/daynnite.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/daynnite.txt",
        },
        {
          id: "turks",
          title:
            "fuwamoco, ironmouse, nanashi mumei, gawr gura - turks (nav, gunna, travis scott)",
          file: "./audio/turks.mp3",
          cover: "./images/turks.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/turks.txt",
        },
        {
          id: "fwmctinydesk",
          title: "fuwamoco - fwmc tiny desk (mac miller)",
          file: "./audio/fwmctinydesk.mp3",
          cover: "./images/fwmctinydesk.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/fwmctinydesk.txt",
        },
        {
          id: "chaseudown",
          title: "FUWAMOCO - CHASEUDOWN (FWMC-AI Original Song)",
          file: "./audio/chaseudown.mp3",
          cover: "./images/chaseudown.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/chaseudown.txt",
        },
        {
          id: "betterhavemymoney",
          title:
            "fuwamoco - better have my money (rihanna, kelly clarkson)",
          file: "./audio/betterhavemymoney.mp3",
          cover: "./images/betterhavemymoney.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/betterhavemymoney.txt",
        },
        {
          id: "alreadyrich",
          title: "fuwamoco, gawr gura - already rich (yeat)",
          file: "./audio/alreadyrich.mp3",
          cover: "./images/alreadyrich.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/alreadyrich.txt",
        },
        {
          id: "jusdiss",
          title: "FUWAMOCO - JUSDISS (FWMC-AI Original Remix)",
          file: "./audio/jusdiss.mp3",
          cover: "./images/jusdiss.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/jusdiss.txt",
        },
        {
          id: "sugasuga",
          title:
            "senzawa, gawr gura - suga suga // sugar (baby bash & frankie j, robin schulz)",
          file: "./audio/sugasuga.mp3",
          cover: "./images/sugasuga.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sugasuga.txt",
        },
        {
          id: "freegura",
          title: "Gawr Gura - #FREEGURA (FWMC-AI Original Song)",
          file: "./audio/freegura.mp3",
          cover: "./images/freegura.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/freegura.txt",
          syncedLyrics: "./lyrics/freegura-synced.txt",
        },
        {
          id: "616inla",
          title: "fuwamoco - 6:16 in la (kendrick lamar)",
          file: "./audio/616inla.mp3",
          cover: "./images/616inla.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/616inla.txt",
        },
        {
          id: "dontswitchnow",
          title:
            "fuwamoco, koseki bijou - dont switch now // laced max (crack, lazer dim 700)",
          file: "./audio/dontswitchnow.mp3",
          cover: "./images/dontswitchnow.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/dontswitchnow.txt",
        },
        {
          id: "institution",
          title: "gawr gura - institution (kodak black)",
          file: "./audio/institution.mp3",
          cover: "./images/institution.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/institution.txt",
        },
        {
          id: "7minutedrill",
          title: "gawr gura - 7 minute drill (j. cole)",
          file: "./audio/7minutedrill.mp3",
          cover: "./images/7minutedrill.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/7minutedrill.txt",
        },
        {
          id: "stickseason",
          title:
            "gawr gura - stick season (noah kahan, olivia rodrigo)",
          file: "./audio/stickseason.mp3",
          cover: "./images/stickseason.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/stickseason.txt",
        },
        {
          id: "houdini",
          title: "mori calliope - houdini (eminem)",
          file: "./audio/houdini.mp3",
          cover: "./images/houdini.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/houdini.txt",
        },
        {
          id: "theholo",
          title: "FUWAMOCO - The Holo (FWMC-AI Original Song)",
          file: "./audio/theholo.mp3",
          cover: "./images/theholo.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/theholo.txt",
        },
        {
          id: "thelondonv",
          title:
            "fuwamoco - the london (young thug, j. cole, travis scott) [violin version]",
          file: "./audio/thelondonv.mp3",
          cover: "./images/thelondonv.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/thelondon.txt",
        },
        {
          id: "thelondon",
          title:
            "fuwamoco - the london (young thug, j. cole, travis scott)",
          file: "./audio/thelondon.mp3",
          cover: "./images/thelondon.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/thelondon.txt",
        },
        {
          id: "pushups",
          title: "mori calliope, gawr gura - push ups (drake)",
          file: "./audio/pushups.mp3",
          cover: "./images/pushups.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/pushups.txt",
        },
        {
          id: "demondogs",
          title: "FUWAMOCO - Demon Dogs (FWMC-AI Original Song)",
          file: "./audio/demondogs.mp3",
          cover: "./images/demondogs.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/demondogs.txt",
        },
        {
          id: "vick",
          title: "Mori Calliope, Gawr Gura - VICK (FWMC-AI Original Song)",
          file: "./audio/vick.mp3",
          cover: "./images/vick.jpg",
          plays: 0,
          category: "original",
          lyrics: "./lyrics/vick.txt",
        },
        {
          id: "bblcalli",
          title: "fuwamoco - BBL CALLI (metro boomin)",
          file: "./audio/bblcalli.mp3",
          cover: "./images/bblcalli.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/bblcalli.txt",
        },
        {
          id: "shoota",
          title:
            "gawr gura, fuwamoco - shoota (playboi carti, lil uzi vert)",
          file: "./audio/shoota.mp3",
          cover: "./images/shoota.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/shoota.txt",
        },
        {
          id: "euphoria",
          title: "mococo abyssgard - euphoria (kendrick lamar)",
          file: "./audio/euphoria.mp3",
          cover: "./images/euphoria.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/euphoria.txt",
        },
        {
          id: "notlikeus",
          title: "fuwamoco - not like us (kendrick lamar)",
          file: "./audio/notlikeus.mp3",
          cover: "./images/notlikeus.png",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/notlikeus.txt",
        },
        {
          id: "sickomode",
          title:
            "mococo abyssgard, gawr gura - sicko mode (travis scott, drake)",
          file: "./audio/sickomode.mp3",
          cover: "./images/sickomode.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sickomode.txt",
        },
        {
          id: "sad",
          title: "fuwamoco - sad! (xxxtentacion)",
          file: "./audio/sad.mp3",
          cover: "./images/sad.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/sad.txt",
        },
        {
          id: "justkeepgoin",
          title: "mococo abyssgard - just keep goin' (tobi lou)",
          file: "./audio/justkeepgoin.mp3",
          cover: "./images/justkeepgoin.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/justkeepgoin.txt",
        },
        {
          id: "hatred",
          title: "fuwamoco - hatred (the kid laroi, lil yachty)",
          file: "./audio/hatred.mp3",
          cover: "./images/hatred.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/hatred.txt",
        },
        {
          id: "likethat",
          title:
            "gawr gura, fuwamoco - like that (future, metro boomin, kendrick lamar)",
          file: "./audio/likethat.mp3",
          cover: "./images/likethat.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/likethat.txt",
        },
        {
          id: "xotourllif3",
          title: "fuwamoco - xo tour llif3 (lil uzi vert)",
          file: "./audio/xotourllif3.mp3",
          cover: "./images/xotourllif3.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/xotourllif3.txt",
        },
        {
          id: "stay",
          title:
            "nyatasha nyanners, fuwamoco - stay (justin beiber, the kid laroi)",
          file: "./audio/stay.mp3",
          cover: "./images/stay.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/stay.txt",
        },
        {
          id: "acti",
          title:
            "gawr gura, fuwamoco - act i // act ii // act iii (4batz, drake)",
          file: "./audio/acti.mp3",
          cover: "./images/acti.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/acti.txt",
        },
        {
          id: "shibuya",
          title: "fuwamoco - shibuya (ski mask the slump god)",
          file: "./audio/shibuya.mp3",
          cover: "./images/shibuya.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/shibuya.txt",
        },
        {
          id: "nonstop",
          title: "fuwamoco - nonstop (drake)",
          file: "./audio/nonstop.mp3",
          cover: "./images/nonstop.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/nonstop.txt",
        },
        {
          id: "plugwalk",
          title: "fuwamoco - plug walk (rich the kid)",
          file: "./audio/plugwalk.mp3",
          cover: "./images/plugwalk.jpg",
          plays: 0,
          category: "cover",
          lyrics: "./lyrics/plugwalk.txt",
        },
      ];

      console.log(
        "Initial playlist order:",
        playlist.map((song) => song.title)
      );
      console.log("Playlist:", playlist);

      const audioPlayer = new Audio();
      audioPlayer.setAttribute("playsinline", "");
      audioPlayer.setAttribute("webkit-playsinline", "");
      audioPlayer.preload = "auto";

      let isFirstVisit =
        !sessionStorage.getItem("appOpened") &&
        !localStorage.getItem("appOpened");
      let isHidden = document.hidden;
      let currentSongIndex = 0;
      let shuffledPlaylist = [...playlist];
      let isShuffled = false;
      let isCustomPlaylistActive = false;
      let currentPlaylistName = "main";
      let currentPlaylist = playlist;
      let currentFilter = "all";
      let isRepeatOn = false;
      console.log(
        "Initial currentPlaylist order:",
        currentPlaylist.map((song) => song.title)
      );

      // DOM elements
      const playlistElement = document.getElementById("playlist");
      const playlistSidebar = document.getElementById("playlistSidebar");
      const closePlaylistBtn = document.getElementById("closePlaylistBtn");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const shuffleBtn = document.getElementById("shuffleBtn");
      const showPlaylistBtn = document.getElementById("showPlaylistBtn");
      const fullPlaylist = document.getElementById("fullPlaylist");
      const progressBar = document.getElementById("progressBar");
      const progressContainer = document.getElementById("progressContainer");
      const progressVisualizer = document.getElementById("progressVisualizer");
      const volumeControl = document.getElementById("volumeControl");
      const currentSongDisplay = document.getElementById("currentSong");
      const currentTimeDisplay = document.getElementById("currentTime");
      const totalDurationDisplay = document.getElementById("totalDuration");
      const togglePlayerBtn = document.getElementById("togglePlayerBtn");
      const playerContainer = document.querySelector(".player-container");
      const playerContent = document.querySelector(".player-content");
      const backToMainBtn = document.getElementById("backToMainBtn");

      // Song Tags
      const newSongs = [
        "burningdesires",
        "chillbae",
        "conceited",
        "sugar",
        "infwmcwetrust",
        "littlesaplings",
      ];
      const turtleSongs = [
        "anacondas",
        "seeyouagain",
        "dieforparty",
        "airplanept2",
        "void",
      ];
      const saintSongs = [
        "dieforyou",
        "sayso",
      ];
      const zzzSongs = [
        "sharksgottabite",
        "sugarcube",
        "burningdesires",
      ];

      function togglePlayer() {
        if (playerContainer.classList.contains("visible")) {
          playerContainer.classList.remove("visible");
          playerContainer.classList.add("minimized");
          togglePlayerBtn.textContent = "Show";
        } else {
          playerContainer.classList.add("visible");
          playerContainer.classList.remove("minimized");
          togglePlayerBtn.textContent = "Hide";
        }
        // Ensure the song info is always visible
        document.querySelector(".song-info").style.display = "block";
      }

      function showPlayer() {
        playerContainer.classList.add("visible");
        playerContainer.classList.remove("minimized");
        togglePlayerBtn.textContent = "Hide";
      }

      // Check if the device is running iOS
      function isIOS() {
        return (
          [
            "iPad Simulator",
            "iPhone Simulator",
            "iPod Simulator",
            "iPad",
            "iPhone",
            "iPod",
          ].includes(navigator.platform) ||
          // iPad on iOS 13 detection
          (navigator.userAgent.includes("Mac") && "ontouchend" in document)
        );
      }

      // Check if the device is running Android
      function isAndroid() {
        return /Android/i.test(navigator.userAgent);
      }

      // Handle audio focus for Android
      function handleAndroidAudioFocus() {
        if (isAndroid() && "AudioContext" in window) {
          const audioContext = new AudioContext();
          document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
              audioContext.suspend();
            } else {
              audioContext.resume();
            }
          });
        }
      }

      // Optimization Functions (Android and iOS)
      function optimizeUIForAndroid() {
        if (isAndroid()) {
          const buttons = document.querySelectorAll(".btn, .control-btn");
          buttons.forEach((button) => {
            button.style.minHeight = "48px";
            button.style.minWidth = "48px";
          });
          document.body.style.fontSize = "16px";
          document.body.style.webkitOverflowScrolling = "touch";
        }
      }

      function optimizeForAndroid() {
        if (/Android/i.test(navigator.userAgent)) {
          // Optimize touch targets
          const buttons = document.querySelectorAll(".btn, .control-btn");
          buttons.forEach((button) => {
            button.style.minHeight = "48px";
            button.style.minWidth = "48px";
            button.style.padding = "12px";
          });

          // Improve scrolling performance
          document.body.style.webkitOverflowScrolling = "touch";

          // Optimize images
          const images = document.querySelectorAll("img");
          images.forEach((img) => {
            img.loading = "lazy";
            img.decoding = "async";
          });

          // Reduce animations for better performance
          document.body.style.setProperty("--transition-speed", "0.2s");

          // Optimize font loading
          const font = new FontFace(
            "Roboto",
            "url(https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Mu4mxK.woff2)"
          );
          font.load().then(() => {
            document.fonts.add(font);
            document.body.style.fontFamily = "Roboto, sans-serif";
          });

          // Implement passive event listeners for better scrolling
          document.addEventListener("touchstart", function () {}, {
            passive: true,
          });
          document.addEventListener("touchmove", function () {}, {
            passive: true,
          });

          // Optimize for Motorola and Google devices specifically
          if (/Motorola|Pixel/i.test(navigator.userAgent)) {
            // Further reduce animations
            document.body.style.setProperty("--transition-speed", "0.1s");

            // Simplify layout for better performance
            document.body.classList.add("simplified-layout");
          }
        }
      }

      function optimizeForSamsung() {
        if (/Samsung/i.test(navigator.userAgent)) {
          // Enable hardware acceleration
          document.body.style.transform = "translateZ(0)";

          // Optimize for Samsung's high-resolution displays
          const metaViewport = document.querySelector("meta[name=viewport]");
          metaViewport.setAttribute(
            "content",
            "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
          );

          // Adjust touch feedback for Samsung's touch sensitivity
          document.body.addEventListener("touchstart", function () {}, {
            passive: true,
          });

          // Optimize scrolling for Samsung's momentum scrolling
          document.body.style.overscrollBehavior = "none";

          // Add Samsung-specific CSS
          const style = document.createElement("style");
          style.textContent = `
            @media screen and (min-width: 360px) and (max-width: 760px) {
                .song {
                    width: calc(50% - 10px);
                }
                .player-container {
                    border-radius: 20px 20px 0 0;
                }
            }
        `;
          document.head.appendChild(style);
        }
      }

      function optimizeForIOS() {
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
          // Enable momentum scrolling
          document.body.style.webkitOverflowScrolling = "touch";

          // Optimize for retina displays
          const highResImages = document.querySelectorAll("img[srcset]");
          highResImages.forEach((img) => {
            img.setAttribute("srcset", img.getAttribute("srcset") + " 2x");
          });

          // Improve tap highlight color
          document.body.style.webkitTapHighlightColor = "rgba(0,0,0,0.1)";

          // Add iOS-specific CSS
          const style = document.createElement("style");
          style.textContent = `
            @supports (-webkit-overflow-scrolling: touch) {
                .player-container {
                    padding-bottom: env(safe-area-inset-bottom);
                }
                .playlist {
                    padding-bottom: 100px;
                }
            }
        `;
          document.head.appendChild(style);

          // Optimize audio playback
          audioPlayer.playsInline = true;
          audioPlayer.setAttribute("webkit-playsinline", "true");
        }
      }

      // Handle Add to Home Screen
      function handleAddToHomeScreen() {
        const addToHomeScreenBtn =
          document.getElementById("addToHomeScreenBtn");
        if (!addToHomeScreenBtn) {
          console.error("Add to Home Screen button not found");
          return;
        }

        let deferredPrompt;

        function isAppInstalled() {
          return (
            window.matchMedia("(display-mode: standalone)").matches ||
            window.navigator.standalone === true ||
            document.referrer.includes("android-app://")
          );
        }

        function isIOS() {
          return (
            /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
          );
        }

        function showAddToHomeScreen() {
          if (!isAppInstalled()) {
            addToHomeScreenBtn.style.display = "inline-block";
            console.log("Add to Home Screen button shown");
          } else {
            addToHomeScreenBtn.style.display = "none";
            console.log(
              "App is already installed, hiding Add to Home Screen button"
            );
          }
        }

        function showInstallInstructions() {
          if (isIOS()) {
            alert(
              'To add this web app to your home screen: tap the Share button, then tap "Add to Home Screen".'
            );
          } else {
            alert(
              'To install this app, use your browser\'s "Install" or "Add to Home Screen" feature. For desktop browsers, check the far right of your address bar for an install icon.'
            );
          }
        }

        function addToHomeScreenClick(e) {
          if (deferredPrompt) {
            console.log("Triggering native Add to Home Screen prompt");
            deferredPrompt.prompt();
            deferredPrompt.userChoice
              .then((choiceResult) => {
                if (choiceResult.outcome === "accepted") {
                  console.log("User accepted the A2HS prompt");
                } else {
                  console.log("User dismissed the A2HS prompt");
                }
                deferredPrompt = null;
                showAddToHomeScreen(); // Update button visibility after user interaction
              })
              .catch((error) => {
                console.error("Error with A2HS prompt:", error);
                showInstallInstructions();
              });
          } else {
            showInstallInstructions();
          }
        }

        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          console.log("beforeinstallprompt event fired");
          showAddToHomeScreen();
        });

        // Check installation status when the page loads
        showAddToHomeScreen();

        // Listen for changes in display mode
        window.matchMedia("(display-mode: standalone)").addListener((e) => {
          showAddToHomeScreen();
        });

        // Add click event listener
        addToHomeScreenBtn.addEventListener("click", addToHomeScreenClick);

        // Simple touch effect for mobile
        addToHomeScreenBtn.addEventListener(
          "touchstart",
          () => addToHomeScreenBtn.classList.add("active"),
          { passive: true }
        );
        addToHomeScreenBtn.addEventListener("touchend", () =>
          addToHomeScreenBtn.classList.remove("active")
        );

        console.log("Add to Home Screen handler initialized");
      }

      // State variables
      let wakeLock = null;
      let userPaused = false;

      async function acquireWakeLock() {
        if ("wakeLock" in navigator) {
          try {
            wakeLock = await navigator.wakeLock.request("screen");
            console.log("Wake Lock is active");

            if (/Android/.test(navigator.userAgent)) {
              setInterval(async () => {
                if (wakeLock) {
                  await wakeLock.release();
                  wakeLock = await navigator.wakeLock.request("screen");
                }
              }, 50000);
            }
          } catch (err) {
            console.error(`${err.name}, ${err.message}`);
          }
        }
      }

      document.addEventListener("DOMContentLoaded", handleAddToHomeScreen);

      function handleAudioFocus() {
        if ("audioFocus" in navigator) {
          navigator.audioFocus
            .request({
              type: "playback",
              autoLoss: false,
              onAudioFocusChanged: (focusType) => {
                if (focusType === "lost") {
                  audioPlayer.pause();
                } else if (focusType === "gained") {
                  audioPlayer
                    .play()
                    .catch((e) =>
                      console.error(
                        "Error resuming after audio focus gained:",
                        e
                      )
                    );
                }
              },
            })
            .catch((e) => console.error("Error requesting audio focus:", e));
        }
      }

      // Helps hide volume slider on mobile devices
      function handleVolumeMobile() {
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );
        const volumeContainer = document.querySelector(".volume-container");

        if (isMobile) {
          volumeContainer.style.display = "none";
        } else {
          volumeContainer.style.display = "flex";
          // Ensure volume control works on desktop
          volumeControl.addEventListener("input", () => {
            audioPlayer.volume = volumeControl.value;
          });
        }
      }

      // Set up background playback
      function setupBackgroundPlayback() {
        if ("mediaSession" in navigator) {
          navigator.mediaSession.setActionHandler("play", () => {
            audioPlayer.play();
            userPaused = false;
          });
          navigator.mediaSession.setActionHandler("pause", () => {
            audioPlayer.pause();
            userPaused = true;
          });
          navigator.mediaSession.setActionHandler(
            "previoustrack",
            playPrevious
          );
          navigator.mediaSession.setActionHandler("nexttrack", playNext);
        }
      }

      console.log("Playlist Element:", document.getElementById("playlist"));

      console.log(
        "About to display playlist:",
        currentPlaylist.map((song) => song.title)
      );
      displayMainPlaylist(currentPlaylist);

      // Create and display the playlist
      function displayMainPlaylist(songs = currentPlaylist) {
    console.log("Displaying main playlist with songs:", songs);
    playlistElement.innerHTML = "";

    const filteredSongs = songs.filter(
        (song) => currentFilter === "all" || song.category === currentFilter
    );

    const songElements = filteredSongs.map((song, index) => {
        const songElement = document.createElement("div");
        songElement.className = "song";
        songElement.setAttribute("data-index", index);
        songElement.setAttribute("data-id", song.id);
        return { songElement, song };
    });

    songElements.forEach(({ songElement }) => {
        playlistElement.appendChild(songElement);
    });

    songElements.forEach(({ songElement, song }, index) => {
        getPlayCount(song.id).then((count) => {
            const titleParts = song.title.split(' - ');
            const coverArtists = titleParts[0];
            const songTitle = titleParts[1].split(' (')[0];
            const originalArtists = titleParts[1].split(' (')[1].replace(')', '');

            songElement.innerHTML = `
    <div class="song-content">
        <img src="${song.cover}" alt="${song.title}" onerror="this.src='./images/default-cover.png'">
        ${newSongs.includes(song.id) ? '<span class="song-tag new-tag">NEW</span>' : ""}
        ${turtleSongs.includes(song.id) ? '<span class="song-tag turtle-tag"></span>' : ""}
        ${saintSongs.includes(song.id) ? '<span class="song-tag turtle-tag"></span>' : ""}
        ${zzzSongs.includes(song.id) ? '<span class="song-tag turtle-tag"></span>' : ""}
        <div class="song-info-container">
            <p class="song-title">${songTitle}</p>
            <p class="cover-artists">${coverArtists}</p>
            <p class="original-artists">${originalArtists}</p>
            <span class="play-count">Plays: 0</span>
        </div>
    </div>
    <div class="song-controls">
        <div class="button-group">
            ${currentPlaylistName !== "main" ?
                `<button class="move-btn move-left-btn" ${index === 0 ? "disabled" : ""}>&larr;</button>
                 <button class="move-btn move-right-btn" ${index === songs.length - 1 ? "disabled" : ""}>&rarr;</button>`
            : ""}
            ${isCustomPlaylistActive && currentPlaylistName !== "search" ?
                `<button class="remove-from-playlist-btn" data-playlist="${currentPlaylistName}" data-index="${index}">Remove</button>`
            : `<button class="add-to-playlist-btn">Add to Playlist</button>`}
        </div>
    </div>
`;
        });
    });

    if (songs.length > 0) {
        updateSongInfo(songs[0]);
    }

    // Re-attach event listener for the playlist
    playlistElement.addEventListener("click", handlePlaylistClick);
}

      // Separate function for playlist click handling
      function handlePlaylistClick(e) {
        const songElement = e.target.closest(".song");
        let index, playlistName;

        if (songElement) {
          index = parseInt(songElement.getAttribute("data-index"));
        }

        if (
          e.target.classList.contains("remove-from-playlist-btn") ||
          e.target.classList.contains("delete-song-btn")
        ) {
          playlistName = e.target.dataset.playlist;
          index = index || parseInt(e.target.dataset.index);
          console.log(
            `Removing song at index ${index} from playlist "${playlistName}"`
          );
          removeSongFromPlaylist(playlistName, index)
            .then(() => {
              console.log("Song removed successfully");
              displayPlaylists();
              // The playlist display will be updated by removeSongFromPlaylist
            })
            .catch((error) => {
              console.error("Error removing song:", error);
              let errorMessage = "An error occurred while removing the song. ";
              if (error.message === "Playlist does not exist") {
                errorMessage += "The playlist could not be found.";
              } else if (error.message === "Invalid songs data") {
                errorMessage += "The playlist structure is invalid.";
              } else if (error.message === "Invalid song index") {
                errorMessage += "The song index is out of range.";
              } else {
                errorMessage += "Please try again.";
              }
              alert(errorMessage);
            });
        } else if (e.target.classList.contains("add-to-playlist-btn")) {
          showAddToPlaylistModal(currentPlaylist[index], e.target);
        } else if (e.target.classList.contains("move-left-btn")) {
          console.log("Moving song left");
          moveSongLeft(index);
        } else if (e.target.classList.contains("move-right-btn")) {
          console.log("Moving song right");
          moveSongRight(index);
        } else if (songElement && !e.target.closest(".button-group")) {
          playSong(index);
        }
      }

      // Play Count Ticker
      function getTotalPlayCount() {
        return database
          .ref("playCounts")
          .once("value")
          .then((snapshot) => {
            const counts = snapshot.val();
            return Object.values(counts).reduce(
              (total, count) => total + count,
              0
            );
          });
      }

      function updateTotalPlayCount() {
        getTotalPlayCount().then((count) => {
          const totalPlayCountElement =
            document.getElementById("totalPlayCount");
          if (totalPlayCountElement) {
            totalPlayCountElement.classList.add(
              "ticker-transition",
              "ticker-hidden"
            );

            setTimeout(() => {
              totalPlayCountElement.textContent = `Total Play Count: ${count.toLocaleString()}`;
              totalPlayCountElement.classList.remove("ticker-hidden");
            }, 500);
          }
        });
      }

      function saveScrollPosition() {
        return window.pageYOffset || document.documentElement.scrollTop;
      }

      function restoreScrollPosition(position) {
        window.scrollTo(0, position);
      }

      // Reorganize Option 1 - Arrows moving songs left or right
      function moveSongLeft(index) {
        if (index > 0 && currentPlaylistName !== "main") {
          const scrollPosition = saveScrollPosition();
          const currentPlayingSong = currentPlaylist[currentSongIndex];
          const songElement = document.querySelector(
            `.song[data-index="${index}"]`
          );
          const prevSongElement = document.querySelector(
            `.song[data-index="${index - 1}"]`
          );

          // Add animation classes
          songElement.classList.add("moving-left");
          prevSongElement.classList.add("moving-right");

          setTimeout(() => {
            [currentPlaylist[index], currentPlaylist[index - 1]] = [
              currentPlaylist[index - 1],
              currentPlaylist[index],
            ];

            if (currentSongIndex === index) {
              currentSongIndex--;
            } else if (currentSongIndex === index - 1) {
              currentSongIndex++;
            }

            displayMainPlaylist(currentPlaylist);
            updateSidebarPlaylist();
            updateMoveButtons();
            updateSongInfo(currentPlayingSong);

            if (currentPlaylistName !== "search") {
              saveCurrentPlaylist();
            }

            // Remove animation classes and add slide-in class
            songElement.classList.remove("moving-left");
            prevSongElement.classList.remove("moving-right");
            songElement.classList.add("slide-in");
            prevSongElement.classList.add("slide-in");

            // Remove slide-in class after animation completes
            setTimeout(() => {
              songElement.classList.remove("slide-in");
              prevSongElement.classList.remove("slide-in");
            }, 300); // 300ms matches the animation duration in CSS

            restoreScrollPosition(scrollPosition);
          }, 300); // This timeout should match the CSS animation duration
        }
      }

      function moveSongRight(index) {
        if (
          index < currentPlaylist.length - 1 &&
          currentPlaylistName !== "main"
        ) {
          const scrollPosition = saveScrollPosition();
          const currentPlayingSong = currentPlaylist[currentSongIndex];
          const songElement = document.querySelector(
            `.song[data-index="${index}"]`
          );
          const nextSongElement = document.querySelector(
            `.song[data-index="${index + 1}"]`
          );

          // Add animation classes
          songElement.classList.add("moving-right");
          nextSongElement.classList.add("moving-left");

          setTimeout(() => {
            [currentPlaylist[index], currentPlaylist[index + 1]] = [
              currentPlaylist[index + 1],
              currentPlaylist[index],
            ];

            if (currentSongIndex === index) {
              currentSongIndex++;
            } else if (currentSongIndex === index + 1) {
              currentSongIndex--;
            }

            displayMainPlaylist(currentPlaylist);
            updateSidebarPlaylist();
            updateMoveButtons();
            updateSongInfo(currentPlayingSong);

            if (currentPlaylistName !== "search") {
              saveCurrentPlaylist();
            }

            // Remove animation classes and add slide-in class
            songElement.classList.remove("moving-right");
            nextSongElement.classList.remove("moving-left");
            songElement.classList.add("slide-in");
            nextSongElement.classList.add("slide-in");

            // Remove slide-in class after animation completes
            setTimeout(() => {
              songElement.classList.remove("slide-in");
              nextSongElement.classList.remove("slide-in");
            }, 300); // 300ms matches the animation duration in CSS

            restoreScrollPosition(scrollPosition);
          }, 300); // This timeout should match the CSS animation duration
        }
      }

      function updateMoveButtons() {
        const songs = document.querySelectorAll(".song");
        songs.forEach((song, index) => {
          const leftBtn = song.querySelector(".move-left-btn");
          const rightBtn = song.querySelector(".move-right-btn");
          if (leftBtn) leftBtn.disabled = index === 0;
          if (rightBtn) rightBtn.disabled = index === songs.length - 1;
        });
      }

      // Reorganize Option 2 - Using Show Playlist and Drag and Drop Feature
      function enableDragAndDrop() {
        const sidebarPlaylist = document.getElementById("fullPlaylist");
        sidebarPlaylist.addEventListener("dragstart", handleSidebarDragStart);
        sidebarPlaylist.addEventListener("dragover", handleSidebarDragOver);
        sidebarPlaylist.addEventListener("drop", handleSidebarDrop);
        sidebarPlaylist.addEventListener("dragend", handleSidebarDragEnd);
      }

      function disableDragAndDrop() {
        const sidebarPlaylist = document.getElementById("fullPlaylist");
        sidebarPlaylist.removeEventListener(
          "dragstart",
          handleSidebarDragStart
        );
        sidebarPlaylist.removeEventListener("dragover", handleSidebarDragOver);
        sidebarPlaylist.removeEventListener("drop", handleSidebarDrop);
        sidebarPlaylist.removeEventListener("dragend", handleSidebarDragEnd);
      }

      function handleSidebarDragStart(e) {
        if (!e.target.matches("li") || e.target.querySelector(".spacer"))
          return;
        e.dataTransfer.setData("text/plain", e.target.dataset.index);
        e.target.classList.add("dragging");
      }

      function handleSidebarDragOver(e) {
        e.preventDefault();
        const draggingElement = document.querySelector(".dragging");
        if (!draggingElement) return;
        const closestElement = getClosestElement(e.clientY);
        if (closestElement) {
          sidebarPlaylist.insertBefore(draggingElement, closestElement);
        } else {
          sidebarPlaylist.appendChild(draggingElement);
        }
      }

      function handleSidebarDrop(e) {
        e.preventDefault();
        const fromIndex = parseInt(e.dataTransfer.getData("text"));
        const toIndex = Array.from(e.target.parentNode.children).indexOf(
          e.target
        );
        if (fromIndex !== toIndex && currentPlaylistName !== "main") {
          reorderPlaylist(currentPlaylistName, fromIndex, toIndex);
        }
      }

      function handleSidebarDragEnd(e) {
        e.target.classList.remove("dragging");
      }

      function getClosestElement(y) {
        const draggableElements = [
          ...document.querySelectorAll("#fullPlaylist li:not(.dragging)"),
        ];
        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // Optimize saveCurrentPlaylist function
      function saveCurrentPlaylist() {
        if (currentPlaylistName !== "main") {
          const deviceId = getDeviceId();
          return database
            .ref(`playlists/${deviceId}/${currentPlaylistName}`)
            .set(currentPlaylist)
            .then(() => {
              console.log(
                `Playlist "${currentPlaylistName}" saved successfully to Firebase`
              );
            })
            .catch((error) => {
              console.error(
                `Error saving playlist "${currentPlaylistName}" to Firebase:`,
                error
              );
            });
        }
      }

      // showAddToPlaylistModal function
      function showAddToPlaylistModal(song, button) {
        const addToPlaylistBtns = document.querySelectorAll(
          ".add-to-playlist-btn"
        );
        addToPlaylistBtns.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        getPlaylists()
          .then((playlists) => {
            let playlistNames = Object.keys(playlists);

            if (playlistNames.length === 0) {
              const defaultPlaylistName = "My Playlist";
              savePlaylist(defaultPlaylistName, []).then(() => {
                playlistNames = [defaultPlaylistName];
                alert(`Created a new playlist: ${defaultPlaylistName}`);
                continueModalDisplay(playlistNames, song, button);
              });
            } else {
              continueModalDisplay(playlistNames, song, button);
            }
          })
          .catch((error) => {
            console.error("Error getting playlists:", error);
            alert(
              "There was an error loading your playlists. Please try again."
            );
          });
      }

      function continueModalDisplay(playlistNames, song, button) {
        if (playlistNames.length === 1) {
          // If there's only one playlist, add the song to it directly
          addSongToPlaylist(playlistNames[0], song).then((result) => {
            if (result.status === "exists") {
              showNotification("Song already exists in the playlist", "info");
            } else if (result.status === "added") {
              showAddAnimation(button);
            } else {
              showNotification("Error adding song to playlist", "error");
            }
          });
          button.classList.remove("active");
          return;
        }

        // If there are multiple playlists, show the modal for selection
        const modal = document.getElementById("addToPlaylistModal");
        const playlistSelect = document.getElementById("playlistSelect");

        playlistSelect.innerHTML = "";
        for (let name of playlistNames) {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          playlistSelect.appendChild(option);
        }

        toggleModal("addToPlaylistModal", true);

        document.getElementById("confirmAddToPlaylist").onclick = () => {
          const selectedPlaylist = playlistSelect.value;
          if (selectedPlaylist) {
            addSongToPlaylist(selectedPlaylist, song).then((result) => {
              if (result.status === "exists") {
                showNotification("Song already exists in the playlist", "info");
              } else if (result.status === "added") {
                showAddAnimation(button);
              } else {
                showNotification("Error adding song to playlist", "error");
              }
            });
            toggleModal("addToPlaylistModal", false);
            button.classList.remove("active");
          } else {
            alert("Please select a playlist.");
          }
        };

        document.getElementById("closeAddToPlaylistModalBtn").onclick = () => {
          toggleModal("addToPlaylistModal", false);
          button.classList.remove("active");
        };
      }

      function showAddAnimation(button) {
        const originalText = button.textContent;
        button.textContent = "";
        button.classList.add("added");

        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove("added");
        }, 1500);
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.textContent = message;
        notification.className = `notification ${type}`;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 3000);
      }

      function createPlaylist() {
        const playlistName = document.getElementById("newPlaylistName").value;
        if (playlistName) {
          console.log(`Creating new playlist: ${playlistName}`);
          const newPlaylist = { name: playlistName, songs: [] };
          console.log("New playlist object:", newPlaylist);

          savePlaylistToFirebase(playlistName, newPlaylist)
            .then((result) => {
              if (result) {
                console.log(`Playlist "${playlistName}" created successfully`);
                toggleModal("createPlaylistModal", false);
                document.getElementById("newPlaylistName").value = "";

                // Update local cache
                return getPlaylistsFromFirebase();
              } else {
                throw new Error("Failed to create playlist");
              }
            })
            .then((firebasePlaylists) => {
              console.log(
                "Fetched playlists from Firebase:",
                firebasePlaylists
              );
              localStorage.setItem(
                "userPlaylists",
                JSON.stringify(firebasePlaylists)
              );
              console.log("Updated localStorage with new playlists");
              displayPlaylists(); // Re-render playlists
              alert("Playlist created successfully!");
            })
            .catch((error) => {
              console.error("Error creating playlist:", error);
              alert(
                "There was an error creating the playlist. Please try again."
              );
            });
        } else {
          alert("Please enter a playlist name.");
        }
      }

      function getPlaylists(forceRefresh = false) {
        console.log(
          "Getting playlists...",
          forceRefresh ? "(Forced refresh)" : ""
        );

        if (!forceRefresh) {
          const cachedPlaylists = localStorage.getItem("userPlaylists");
          if (cachedPlaylists) {
            console.log("Using cached playlists from localStorage");
            return Promise.resolve(JSON.parse(cachedPlaylists));
          }
        }

        return getPlaylistsFromFirebase()
          .then((firebasePlaylists) => {
            console.log("Playlists fetched from Firebase:", firebasePlaylists);
            localStorage.setItem(
              "userPlaylists",
              JSON.stringify(firebasePlaylists)
            );
            return firebasePlaylists;
          })
          .catch((error) => {
            console.error("Error fetching playlists:", error);
            throw error;
          });
      }

      function getPlaylistsFromFirebase() {
        const deviceId = getDeviceId();
        console.log(`Fetching playlists from Firebase for device ${deviceId}`);
        return firebase
          .database()
          .ref(`playlists/${deviceId}`)
          .get()
          .then((snapshot) => {
            const playlists = snapshot.val() || {};
            console.log("Raw playlists fetched from Firebase:", playlists);

            // Validate and normalize playlist structure
            const normalizedPlaylists = {};
            for (const [name, playlist] of Object.entries(playlists)) {
              console.log(`Processing playlist "${name}":`, playlist);
              if (Array.isArray(playlist)) {
                // If the playlist is already an array, use it as is
                normalizedPlaylists[name] = {
                  name: name,
                  songs: playlist,
                };
              } else if (playlist && Array.isArray(playlist.songs)) {
                // If the playlist has a songs array, use that
                normalizedPlaylists[name] = playlist;
              } else if (playlist && typeof playlist === "object") {
                // If the playlist is an object, try to extract songs
                normalizedPlaylists[name] = {
                  name: name,
                  songs: Object.values(playlist).filter(
                    (item) => typeof item === "object" && item.title
                  ),
                };
              } else {
                console.warn(
                  `Playlist "${name}" has invalid structure:`,
                  playlist
                );
                normalizedPlaylists[name] = { name: name, songs: [] };
              }
              console.log(
                `Normalized playlist "${name}":`,
                normalizedPlaylists[name]
              );
            }

            console.log("All normalized playlists:", normalizedPlaylists);
            return normalizedPlaylists;
          })
          .catch((error) => {
            console.error("Error fetching playlists from Firebase:", error);
            console.error("Error code:", error.code);
            console.error("Error message:", error.message);
            throw error;
          });
      }

      function refreshPlaylists() {
        console.log("Refreshing playlists...");
        const refreshButton = document.getElementById("refreshPlaylistsBtn");
        refreshButton.disabled = true;
        refreshButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

        const deviceId = getDeviceId();

        firebase
          .database()
          .ref(`playlists/${deviceId}`)
          .once("value")
          .then((snapshot) => {
            const playlists = snapshot.val();
            if (playlists && Object.keys(playlists).length > 0) {
              console.log(`Playlists found for Device ID: ${deviceId}`);
              const currentPlaylists =
                JSON.parse(localStorage.getItem("userPlaylists")) || {};
              const mergedPlaylists = { ...currentPlaylists, ...playlists };
              localStorage.setItem(
                "userPlaylists",
                JSON.stringify(mergedPlaylists)
              );
              displayPlaylists(true); // Force a refresh of the display
              showNotification("Playlists refreshed successfully", "info");
            } else {
              console.log(`No playlists found for Device ID: ${deviceId}`);
              return attemptPlaylistRetrieval(0);
            }
          })
          .catch((error) => {
            console.error(
              `Error fetching playlists for Device ID ${deviceId}:`,
              error
            );
            return attemptPlaylistRetrieval(0);
          })
          .finally(() => {
            refreshButton.disabled = false;
            refreshButton.innerHTML =
              '<i class="fas fa-sync-alt"></i> Refresh Playlists';
          });

        function attemptPlaylistRetrieval(index) {
          const knownDeviceIds = getAllKnownDeviceIds();

          if (index >= knownDeviceIds.length) {
            console.log("No new playlists found for any known device IDs");
            showNotification(
              "No new playlists found. Your current playlists are up to date.",
              "info"
            );
            displayPlaylists(true); // Refresh display even if no new playlists are found
            return Promise.resolve();
          }

          const currentDeviceId = knownDeviceIds[index];
          console.log(
            `Attempting to fetch playlists for device ID: ${currentDeviceId}`
          );

          return firebase
            .database()
            .ref(`playlists/${currentDeviceId}`)
            .once("value")
            .then((snapshot) => {
              const fetchedPlaylists = snapshot.val();
              if (
                fetchedPlaylists &&
                Object.keys(fetchedPlaylists).length > 0
              ) {
                console.log(
                  `Playlists found for device ID: ${currentDeviceId}`
                );

                // Merge new playlists with existing ones
                let existingPlaylists =
                  JSON.parse(localStorage.getItem("userPlaylists")) || {};
                const mergedPlaylists = {
                  ...existingPlaylists,
                  ...fetchedPlaylists,
                };

                localStorage.setItem(
                  "userPlaylists",
                  JSON.stringify(mergedPlaylists)
                );
                displayPlaylists(true); // Force a refresh of the display
                showNotification("Playlists updated successfully", "info");
                return Promise.resolve();
              } else {
                console.log(
                  `No new playlists found for device ID: ${currentDeviceId}`
                );
                return attemptPlaylistRetrieval(index + 1);
              }
            })
            .catch((error) => {
              console.error(
                `Error fetching playlists for device ID ${currentDeviceId}:`,
                error
              );
              return attemptPlaylistRetrieval(index + 1);
            });
        }
        // Start the retrieval process
        attemptPlaylistRetrieval(0);
      }

      getPlaylistsFromFirebase() // Use this instead of getPlaylists(true)
        .then((playlists) => {
          console.log("Fetched playlists:", playlists);
          localStorage.setItem("userPlaylists", JSON.stringify(playlists));
          displayPlaylists();
          console.log("Playlists refreshed successfully");
          showNotification("Playlists refreshed successfully", "info");
        })
        .catch((error) => {
          console.error("Error refreshing playlists:", error);
          showNotification(
            "Error refreshing playlists. Please try again.",
            "error"
          );
        })
        .finally(() => {
          refreshButton.disabled = false;
          refreshButton.innerHTML =
            '<i class="fas fa-sync-alt"></i> Refresh Playlists';
        });

      function displayPlaylists(forceRefresh = false) {
        console.log(
          "Displaying playlists...",
          forceRefresh ? "(Forced refresh)" : ""
        );

        const playlistsPromise = forceRefresh
          ? getPlaylistsFromFirebase()
          : getPlaylists();

        playlistsPromise
          .then((playlists) => {
            console.log("Playlists to display:", playlists);
            const playlistsList = document.getElementById("playlistsList");
            if (!playlistsList) {
              console.error("Playlist list element not found");
              return;
            }

            // Display device ID
            displayDeviceId();
            const expandedStates = {};

            // Save current expanded states
            document.querySelectorAll(".playlist-songs").forEach((songList) => {
              expandedStates[songList.dataset.playlist] =
                songList.style.display !== "none";
            });

            playlistsList.innerHTML = ""; // Clear existing content

            if (!playlists || Object.keys(playlists).length === 0) {
              playlistsList.innerHTML =
                "<p>No playlists found. Create a new playlist to get started!</p>";
              console.log("No playlists to display");
              return;
            }

            Object.entries(playlists).forEach(([name, playlist]) => {
              console.log(`Creating element for playlist: ${name}`);
              const li = document.createElement("li");
              const isExpanded = expandedStates[name] || false;
              const songs = playlist.songs || [];
              const isDisabled = songs.length === 0;
              console.log(
                `Playlist "${name}" has ${
                  songs.length
                } songs. Buttons will be ${
                  isDisabled ? "disabled" : "enabled"
                }.`
              );

              li.innerHTML = `
                <div class="playlist-header">
                    <h3>
                        <span class="playlist-name" data-playlist="${name}">${name}</span>
                        <i class="fas fa-pencil-alt rename-playlist-btn" data-playlist="${name}" title="Rename playlist"></i>
                        <span class="song-count">(${songs.length} songs)</span>
                    </h3>
                    <button class="play-playlist-btn btn" data-playlist="${name}" ${
                isDisabled ? "disabled" : ""
              }>Play Playlist</button>
                    <button class="go-to-playlist-btn btn" data-playlist="${name}" ${
                isDisabled ? "disabled" : ""
              }>Go to Playlist</button>
                    <button class="toggle-songs-btn btn" data-playlist="${name}">${
                isExpanded ? "Hide Songs" : "Show Songs"
              }</button>
                    <button class="delete-playlist-btn btn" data-playlist="${name}">Delete Playlist</button>
                </div>
                <ul class="playlist-songs" data-playlist="${name}" style="display: ${
                isExpanded ? "block" : "none"
              };">
                    ${
                      songs.length > 0
                        ? songs
                            .map(
                              (song, index) => `
                        <li draggable="true" data-index="${index}">
                            <span class="drag-handle"></span>
                            ${song.title || "Untitled Song"}
                            <button class="delete-song-btn btn" data-playlist="${name}" data-index="${index}">Remove</button>
                        </li>
                    `
                            )
                            .join("")
                        : "<li>This playlist is empty</li>"
                    }
                </ul>
                `;
              playlistsList.appendChild(li);

              // Add direct event listeners to buttons
              const playButton = li.querySelector(".play-playlist-btn");
              const goToButton = li.querySelector(".go-to-playlist-btn");

              if (playButton) {
                playButton.addEventListener("click", (e) => {
                  console.log(`Direct click on play button for ${name}`);
                  if (isDisabled) {
                    console.log(
                      `Play button for ${name} is disabled, showing alert`
                    );
                    alert(
                      `The playlist "${name}" is empty. Please add songs before playing.`
                    );
                    e.stopPropagation();
                  }
                });
              }

              if (goToButton) {
                goToButton.addEventListener("click", (e) => {
                  console.log(`Direct click on go to button for ${name}`);
                  if (isDisabled) {
                    console.log(
                      `Go to button for ${name} is disabled, showing alert`
                    );
                    alert(
                      `The playlist "${name}" is empty. Please add songs before viewing.`
                    );
                    e.stopPropagation();
                  }
                });
              }
            });

            console.log("Playlists displayed");
            setupPlaylistSongsDragAndDrop();

            // Log the state of buttons after they've been added to the DOM
            playlistsList
              .querySelectorAll(".play-playlist-btn, .go-to-playlist-btn")
              .forEach((button) => {
                console.log(
                  `Button for "${button.dataset.playlist}" (${button.textContent}): disabled = ${button.disabled}`
                );
              });
          })
          .catch((error) => {
            console.error("Error displaying playlists:", error);
            const playlistsList = document.getElementById("playlistsList");
            if (playlistsList) {
              playlistsList.innerHTML =
                "<p>Error loading playlists. Please try again later.</p>";
            }
          });
      }

      // Drag and drop playlist
      function handleDragStart(e) {
        e.dataTransfer.setData("text/plain", e.target.dataset.index);
      }

      function handleDragOver(e) {
        e.preventDefault();
      }

      function handleDrop(e) {
        e.preventDefault();
        const playlistName = e.currentTarget.dataset.playlist;
        const fromIndex = parseInt(e.dataTransfer.getData("text"));
        const toIndex = parseInt(e.target.closest("li").dataset.index);
        if (fromIndex !== toIndex) {
          reorderPlaylist(playlistName, fromIndex, toIndex);
          displayPlaylists();
        }
      }

      function reorderPlaylist(playlistName, fromIndex, toIndex) {
        if (playlistName === "main") return;

        const deviceId = getDeviceId();
        return database
          .ref(`playlists/${deviceId}/${playlistName}`)
          .once("value")
          .then((snapshot) => {
            let playlist = snapshot.val() || [];
            const [movedItem] = playlist.splice(fromIndex, 1);
            playlist.splice(toIndex, 0, movedItem);

            // Update currentSongIndex if necessary
            if (playlistName === currentPlaylistName) {
              if (currentSongIndex === fromIndex) {
                currentSongIndex = toIndex;
              } else if (
                fromIndex < currentSongIndex &&
                toIndex >= currentSongIndex
              ) {
                currentSongIndex--;
              } else if (
                fromIndex > currentSongIndex &&
                toIndex <= currentSongIndex
              ) {
                currentSongIndex++;
              }
            }

            return database
              .ref(`playlists/${deviceId}/${playlistName}`)
              .set(playlist)
              .then(() => playlist);
          })
          .then((updatedPlaylist) => {
            console.log(`Playlist "${playlistName}" reordered successfully`);
            if (playlistName === currentPlaylistName) {
              currentPlaylist = updatedPlaylist;
              displayMainPlaylist(currentPlaylist);
            }
            updateSidebarPlaylist();
            displayPlaylists(); // Refresh the View Playlists modal
          })
          .catch((error) => {
            console.error(
              `Error reordering playlist "${playlistName}" in Firebase:`,
              error
            );
          });
      }

      // Custom playlist playable
      function playCustomPlaylist(playlistName) {
        getPlaylistFromFirebase(playlistName)
          .then((playlist) => {
            console.log(`Retrieved playlist "${playlistName}":`, playlist);
            if (
              playlist &&
              Array.isArray(playlist.songs) &&
              playlist.songs.length > 0
            ) {
              currentPlaylist = playlist.songs;
              currentPlaylistName = playlistName;
              isCustomPlaylistActive = true;
              currentSongIndex = 0;
              displayMainPlaylist(currentPlaylist); // Update the main view
              playSong(0);
              updateSidebarPlaylist();
              showBackToMainButton();
            } else {
              console.error(
                `Playlist "${playlistName}" is empty or has invalid structure:`,
                playlist
              );
              alert("This playlist is empty. Add some songs before playing.");
            }
          })
          .catch((error) => {
            console.error(`Error loading playlist "${playlistName}":`, error);
            alert("There was an error loading the playlist. Please try again.");
          });
      }

      // Get playlist from Firebase
      function getPlaylistFromFirebase(playlistName) {
        const deviceId = getDeviceId();
        return database
          .ref(`playlists/${deviceId}/${playlistName}`)
          .get()
          .then((snapshot) => {
            let playlistData = snapshot.val();
            console.log(
              `Raw playlist data for "${playlistName}":`,
              playlistData
            );

            if (!playlistData) {
              return { name: playlistName, songs: [] };
            }

            let songs;
            if (Array.isArray(playlistData)) {
              songs = playlistData;
              playlistData = { name: playlistName, songs: songs };
            } else if (
              playlistData.songs &&
              Array.isArray(playlistData.songs)
            ) {
              songs = playlistData.songs;
            } else if (typeof playlistData === "object") {
              songs = Object.values(playlistData).filter(
                (item) => typeof item === "object" && item.title
              );
              playlistData = { name: playlistName, songs: songs };
            } else {
              console.error(
                `Invalid playlist data structure for "${playlistName}"`
              );
              return Promise.reject(
                new Error("Invalid playlist data structure")
              );
            }

            playlistData.name = playlistData.name || playlistName;
            console.log(
              `Normalized playlist data for "${playlistName}":`,
              playlistData
            );
            return playlistData;
          });
      }

      function updatePlaylistDisplay(playlistName, updatedPlaylist) {
        console.log(
          `Updating display for playlist "${playlistName}"`,
          updatedPlaylist
        );

        if (!updatedPlaylist) {
          console.error(`Playlist "${playlistName}" is undefined`);
          return;
        }

        // Update the main playlist view if it's the current playlist
        if (currentPlaylistName === playlistName) {
          console.log(`Updating main playlist view for "${playlistName}"`);
          displayMainPlaylist(updatedPlaylist);
        }

        // Update the playlist in the "View Playlists" modal
        const playlistElement = document.querySelector(
          `#playlistsList li:has(.playlist-songs[data-playlist="${playlistName}"])`
        );
        if (playlistElement) {
          console.log(`Updating View Playlists modal for "${playlistName}"`);
          const songsList = playlistElement.querySelector(".playlist-songs");
          const songCount = playlistElement.querySelector(".song-count");

          songsList.innerHTML = updatedPlaylist
            .map(
              (song, index) => `
            <li draggable="true" data-index="${index}">
                <span class="drag-handle"></span>
                ${song.title}
                <button class="delete-song-btn btn" data-playlist="${playlistName}" data-index="${index}">Remove</button>
            </li>
        `
            )
            .join("");

          songCount.textContent = `(${updatedPlaylist.length} songs)`;
        } else {
          console.warn(
            `Playlist element for "${playlistName}" not found in View Playlists modal`
          );
        }

        // Update the sidebar playlist if it's open
        if (playlistSidebar.classList.contains("open")) {
          console.log(`Updating sidebar playlist for "${playlistName}"`);
          updateSidebarPlaylist();
        }

        // Update currentPlaylist if the updated playlist is the current one
        if (currentPlaylistName === playlistName) {
          currentPlaylist = updatedPlaylist;
        }

        setupPlaylistSongsDragAndDrop();
        console.log(`Playlist display update complete for "${playlistName}"`);
      }

      function showBackToMainButton() {
        backToMainBtn.style.display = "inline-block";
        showPlaylistBtn.textContent = "Show Current Playlist";
      }

      function hideBackToMainButton() {
        backToMainBtn.style.display = "none";
        showPlaylistBtn.textContent = "Show Playlist";
      }

      function backToMainPlaylist() {
        if (currentPlaylistName !== "main" || isCustomPlaylistActive) {
          currentPlaylist = playlist;
          currentPlaylistName = "main";
          isCustomPlaylistActive = false;
          displayMainPlaylist(playlist);
          hideBackToMainButton();
          searchInput.value = ""; // Clear the search input
        }
        // If we're already on the main playlist, just reset the view
        if (isShuffled) {
          shufflePlaylist(); // This will un-shuffle the playlist
        }
        updateSidebarPlaylist();
      }

      // Shuffle the playlist
      function shufflePlaylist() {
        isShuffled = !isShuffled;
        console.log("Shuffle state:", isShuffled);

        if (isShuffled) {
          const currentSong = currentPlaylist[currentSongIndex];

          // Create a copy of the current playlist without the current song
          shuffledPlaylist = currentPlaylist.filter(
            (song) => song !== currentSong
          );

          // Perform Fisher-Yates shuffle on the remaining songs
          for (let i = shuffledPlaylist.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledPlaylist[i], shuffledPlaylist[j]] = [
              shuffledPlaylist[j],
              shuffledPlaylist[i],
            ];
          }

          // Add the current song back to the beginning
          shuffledPlaylist.unshift(currentSong);
          currentSongIndex = 0;

          displayMainPlaylist(shuffledPlaylist);
          shuffleBtn.textContent = "Unshuffle";
          shuffleBtn.classList.add("active");
        } else {
          // When unshuffling, find the index of the current song in the original playlist
          const currentShuffledSong = shuffledPlaylist[currentSongIndex];
          currentSongIndex = currentPlaylist.findIndex(
            (song) => song.id === currentShuffledSong.id
          );
          shuffledPlaylist = null; // Clear the shuffled playlist
          displayMainPlaylist(currentPlaylist);
          shuffleBtn.textContent = "Shuffle";
          shuffleBtn.classList.remove("active");
        }

        console.log("Button text:", shuffleBtn.textContent);
        console.log("Button classes:", shuffleBtn.className);

        if (playlistSidebar.classList.contains("open")) {
          updateSidebarPlaylist();
        }

        // Update song info with the correct current song
        const currentSong = isShuffled
          ? shuffledPlaylist[currentSongIndex]
          : currentPlaylist[currentSongIndex];
        updateSongInfo(currentSong);
        forceButtonRedraw(shuffleBtn);
      }

      // Search songs in the playlist
      function searchSongs() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const filteredSongs = playlist.filter((song) =>
          song.title.toLowerCase().includes(searchTerm)
        );
        currentPlaylist = filteredSongs;
        currentPlaylistName = "search";
        isCustomPlaylistActive = true;
        displayMainPlaylist(filteredSongs);
        updateSidebarPlaylist();
        showBackToMainButton();
        updatePlaylistButtonText(playlistSidebar.classList.contains("open"));
      }

      function setupSearchInputListener() {
        const searchInput = document.getElementById("searchInput");

        searchInput.addEventListener("keyup", function (event) {
          // Check if the pressed key is 'Enter'
          if (event.key === "Enter") {
            // Prevent the default form submission behavior
            event.preventDefault();
            // Trigger the search function
            searchSongs();
          }
        });
      }

      // Playlist Event Listeners
      function setupPlaylistEventListeners() {
        console.log("Setting up playlist event listeners");
        const playlistsList = document.getElementById("playlistsList");
        const mainPlaylistArea = document.getElementById("playlist");

        function handleSongRemoval(playlistName, songIndex, event) {
          event.stopPropagation(); // Stop event from bubbling up
          removeSongFromPlaylist(playlistName, songIndex)
            .then((success) => {
              if (success) {
                console.log("Song removed and playlist updated successfully");
              } else {
                console.error("Failed to remove the song");
                alert("Failed to remove the song. Please try again.");
              }
            })
            .catch((error) => {
              console.error("Error removing song from playlist:", error);
              alert(
                "An error occurred while removing the song. Please try again."
              );
            });
        }

        playlistsList.addEventListener("click", (e) => {
          console.log("Playlist item clicked:", e.target);

          if (
            e.target.classList.contains("play-playlist-btn") ||
            e.target.classList.contains("go-to-playlist-btn")
          ) {
            console.log("Play or Go to playlist button clicked");
            const playlistName = e.target.dataset.playlist;
            console.log("Playlist name:", playlistName);

            // Check if the button is disabled
            if (e.target.disabled) {
              console.log("Button is disabled");
              alert(
                `The playlist "${playlistName}" is empty. Please add songs before playing or viewing.`
              );
              return;
            }

            // If the button is not disabled, proceed with normal operation
            if (e.target.classList.contains("play-playlist-btn")) {
              console.log("Attempting to play custom playlist");
              playCustomPlaylist(playlistName);
            } else if (e.target.classList.contains("go-to-playlist-btn")) {
              console.log("Attempting to go to playlist");
              goToPlaylist(playlistName);
            }
          } else if (e.target.classList.contains("delete-playlist-btn")) {
            const playlistName = e.target.dataset.playlist;
            if (
              confirm(
                `Are you sure you want to delete the playlist "${playlistName}"?`
              )
            ) {
              deletePlaylist(playlistName)
                .then((success) => {
                  if (success) {
                    displayPlaylists();
                  } else {
                    alert("Failed to delete the playlist. Please try again.");
                  }
                })
                .catch((error) => {
                  console.error("Error deleting playlist:", error);
                  alert(
                    "An error occurred while deleting the playlist. Please try again."
                  );
                });
            }
          } else if (e.target.classList.contains("delete-song-btn")) {
            const playlistName = e.target.dataset.playlist;
            const songIndex = parseInt(e.target.closest("li").dataset.index);
            handleSongRemoval(playlistName, songIndex, e);
          } else if (e.target.classList.contains("toggle-songs-btn")) {
            const playlistName = e.target.dataset.playlist;
            const songsList = document.querySelector(
              `.playlist-songs[data-playlist="${playlistName}"]`
            );
            if (songsList) {
              const isHidden = songsList.style.display === "none";
              songsList.style.display = isHidden ? "block" : "none";
              e.target.textContent = isHidden ? "Hide Songs" : "Show Songs";
            }
          } else if (e.target.classList.contains("rename-playlist-btn")) {
            const playlistName = e.target.dataset.playlist;
            const newName = prompt(
              `Enter new name for playlist "${playlistName}":`,
              playlistName
            );
            if (newName && newName !== playlistName) {
              renamePlaylist(playlistName, newName);
            }
          }
        });

        // Add event listener for the main playlist area
        mainPlaylistArea.addEventListener("click", (e) => {
          if (e.target.classList.contains("remove-from-playlist-btn")) {
            const songElement = e.target.closest(".song");
            const songIndex = parseInt(songElement.dataset.index);
            handleSongRemoval(currentPlaylistName, songIndex, e);
          }
        });
      }

      // Toggle playlist sidebar & switch name of playlists
      function togglePlaylist() {
        const isOpen = playlistSidebar.classList.contains("open");
        updatePlaylistButtonText(!isOpen);
        playlistSidebar.classList.toggle("open");
        if (!isOpen) {
          updateSidebarPlaylist();
        }
      }

      function updatePlaylistButtonText(willBeOpen) {
        if (willBeOpen) {
          showPlaylistBtn.textContent =
            currentPlaylistName === "search"
              ? "Hide Search Results"
              : isCustomPlaylistActive
              ? "Hide Current Playlist"
              : "Hide Full Playlist";
        } else {
          showPlaylistBtn.textContent =
            currentPlaylistName === "search"
              ? "Show Search Results"
              : isCustomPlaylistActive
              ? "Show Current Playlist"
              : "Show Full Playlist";
        }
      }

      function switchPlaylist(playlistName) {
        if (playlistName === "main") {
          currentPlaylist = playlist;
          currentPlaylistName = "main";
          isCustomPlaylistActive = false;
          document.getElementById("backToMainBtn").style.display = "none";
        } else {
          const deviceId = getDeviceId();
          database
            .ref(`playlists/${deviceId}/${playlistName}`)
            .once("value")
            .then((snapshot) => {
              const customPlaylist = snapshot.val();
              if (customPlaylist && customPlaylist.length > 0) {
                currentPlaylist = customPlaylist;
                currentPlaylistName = playlistName;
                isCustomPlaylistActive = true;
                document.getElementById("backToMainBtn").style.display =
                  "inline-block";
              } else {
                console.error(
                  `Playlist "${playlistName}" is empty or does not exist`
                );
                alert("This playlist is empty or does not exist.");
                return;
              }
              currentSongIndex = 0;
              updateSidebarPlaylist();
              updatePlaylistButtonText();
              displayMainPlaylist(currentPlaylist);
              if (playlistSidebar.classList.contains("open")) {
                updateSidebarPlaylist();
              }
            })
            .catch((error) => {
              console.error(
                `Error fetching playlist "${playlistName}" from Firebase:`,
                error
              );
              alert(
                "There was an error loading the playlist. Please try again."
              );
            });
        }
      }

      // Update current song information
      function updateSongInfo(song) {
    const currentSongElement = document.getElementById("currentSong");
    const scrollContainer = document.querySelector(".scroll-container");

    // Format the song information
    const titleParts = song.title.split(' - ');
    const coverArtists = titleParts[0];
    const songTitle = titleParts[1].split(' (')[0];
    const originalArtists = titleParts[1].split(' (')[1].replace(')', '');
    const formattedTitle = `${coverArtists} - ${songTitle} (${originalArtists})`;

    currentSongElement.textContent = formattedTitle;

    // Reset animation
    currentSongElement.style.animation = "none";
    currentSongElement.offsetHeight; // Trigger reflow

    // Check if scrolling is necessary
    if (currentSongElement.offsetWidth > scrollContainer.offsetWidth) {
        const scrollDistance = currentSongElement.offsetWidth - scrollContainer.offsetWidth;
        const duration = Math.max(10, scrollDistance * 0.03); // Adjust timing based on scroll distance
        currentSongElement.style.animation = `marquee-scroll ${duration}s linear infinite`;

        // Add a slight delay before starting the animation
        setTimeout(() => {
            currentSongElement.style.transform = "translateX(0)";
        }, 100);
    } else {
        currentSongElement.style.animation = "none";
        currentSongElement.style.transform = "translateX(0)";
    }

    // Update media session metadata if available
    if ("mediaSession" in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: songTitle,
            artist: coverArtists,
            album: `Cover of ${originalArtists}`,
            artwork: [
                { src: song.cover, sizes: "96x96", type: "image/png" },
                { src: song.cover, sizes: "128x128", type: "image/png" },
                { src: song.cover, sizes: "192x192", type: "image/png" },
                { src: song.cover, sizes: "256x256", type: "image/png" },
                { src: song.cover, sizes: "384x384", type: "image/png" },
                { src: song.cover, sizes: "512x512", type: "image/png" },
            ],
        });
    }
}

      // Update full playlist in sidebar
      function updateFullPlaylist() {
        fullPlaylist.innerHTML = "";
        playlist.forEach((song, index) => {
          const li = document.createElement("li");
          li.textContent = song.title;
          li.addEventListener("click", () => {
            playSong(index);
            highlightPlayingSong();
          });
          fullPlaylist.appendChild(li);
        });
        highlightPlayingSong();
      }

      // Highlight the currently playing song in the playlist
      function highlightPlayingSong(customPlaylist) {
        console.log("Highlighting playing song");
        const playlistItems = document.querySelectorAll(
          "#fullPlaylist li, .playlist-songs li"
        );
        const currentSong = currentPlaylist[currentSongIndex];

        playlistItems.forEach((item, index) => {
          if (!item) {
            console.warn(
              `Playlist item at index ${index} is null or undefined`
            );
            return; // Skip this iteration
          }
          try {
            if (customPlaylist) {
              const playlistElement = item.closest(".playlist-songs");
              if (
                playlistElement &&
                playlistElement.dataset &&
                playlistElement.dataset.playlist
              ) {
                item.classList.toggle(
                  "playing",
                  index === currentSongIndex &&
                    playlistElement.dataset.playlist === customPlaylist.name
                );
              } else {
                console.warn(
                  `Custom playlist element or its dataset is undefined for item at index ${index}`
                );
              }
            } else {
              const songTitle = item.querySelector(".song-title");
              if (songTitle) {
                const isPlaying = songTitle.textContent === currentSong.title;
                item.classList.toggle("playing", isPlaying);
              } else {
                item.classList.toggle("playing", index === currentSongIndex);
              }
            }
          } catch (error) {
            console.error(`Error highlighting song at index ${index}:`, error);
          }
        });
      }

      // Handle visibility change
      function handleVisibilityChange() {
  if (document.hidden) {
    // Page is hidden
    // We don't need to do anything here, as we want to continue playing in the background if it's already playing
  } else {
    // Page is visible again
    // Update the UI to reflect the current playback state
    updatePlayPauseButton();
  }
}

// Modify the updatePlayPauseButton function to update both the main player and lyrics modal buttons
function updatePlayPauseButton() {
  const mainPlayPauseBtn = document.getElementById('playPauseBtn');
  const lyricsPlayPauseBtn = document.getElementById('lyricsPlayPauseBtn');
  const isPlaying = !audioPlayer.paused;

  [mainPlayPauseBtn, lyricsPlayPauseBtn].forEach(btn => {
    if (btn) {
      btn.innerHTML = isPlaying 
        ? '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' // Pause icon
        : '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>'; // Play icon
      btn.classList.toggle('play', !isPlaying);
      btn.classList.toggle('pause', isPlaying);
    }
  });
}

      // Get play count for a song
      function getPlayCount(songId) {
        return new Promise((resolve) => {
          const songRef = database.ref("playCounts/" + songId);
          songRef.once("value").then((snapshot) => {
            resolve(snapshot.val() || 0);
          });
        });
      }

      // Increment play count for a song
      function incrementPlayCount(songId) {
        const songRef = database.ref("playCounts/" + songId);
        return songRef
          .transaction((currentCount) => {
            return (currentCount || 0) + 1;
          })
          .then(() => {
            updateTotalPlayCount();
          })
          .catch((error) => {
            console.error("Error incrementing play count:", error);
          });
      }

      function setupPlayCountListener() {
        database.ref("playCounts").on("value", (snapshot) => {
          updateTotalPlayCount();
        });
      }

      // Update play count display
      function updatePlayCountDisplay(song) {
        getPlayCount(song.id).then((count) => {
          const songElements = document.querySelectorAll(".song");
          const songElement = Array.from(songElements).find(
            (el) => el.dataset.id === song.id
          );
          if (songElement) {
            const playCountSpan = songElement.querySelector(".play-count");
            if (playCountSpan) {
              playCountSpan.textContent = `Plays: ${count}`;
            }
          }
        });
      }

      // Play a song from the playlist
      function playSong(index) {
  // Reset repeat state when a new song is played
  isRepeatOn = false;
  updateRepeatButtonState();
  const playlist = isShuffled ? shuffledPlaylist : currentPlaylist;
  if (index < 0 || index >= playlist.length) {
    console.error(
      `Invalid song index: ${index}. Playlist length: ${playlist.length}`
    );
    return;
  }

  currentSongIndex = index;
  const song = playlist[currentSongIndex];

  if (!song || !song.file) {
    console.error(`Invalid song object at index ${index}:`, song);
    return;
  }

  console.log(`Playing song: ${song.title}`);
  audioPlayer.src = song.file;
  audioPlayer.load();
  audioPlayer
    .play()
    .then(() => {
      userPaused = false;
      updateSongInfo(song);
      updatePlayPauseButton();
      updateSidebarPlaylist();
      setupMediaSession(song);
      acquireWakeLock().catch(console.error);
      showPlayer();
      incrementPlayCount(song.id).then(() => {
        updatePlayCountDisplay(song);
      });

      // Check if lyrics modal is open and update lyrics
      if (document.getElementById('lyricsModal').style.display === 'block') {
        console.log("Lyrics modal is open, updating lyrics");
        updateLyricsModal();
      }
    })
    .catch(handleAudioError);

  // Update lyrics if the modal is open
  if (document.getElementById('lyricsModal').style.display === 'block') {
    console.log("Lyrics modal is open, updating lyrics");
    updateLyricsModal();
  }
}

      function playAudioFromResponse(response) {
        response
          .blob()
          .then(function (blob) {
            const objectURL = URL.createObjectURL(blob);
            audioPlayer.src = objectURL;
            return audioPlayer.play();
          })
          .then(() => {
            userPaused = false;
            console.log(
              "Started playing:",
              currentPlaylist[currentSongIndex].title
            );
            updateSongInfo(currentPlaylist[currentSongIndex]);
            updatePlayPauseButton();
            if (playlistSidebar.classList.contains("open")) {
              updateSidebarPlaylist();
            }
            setupMediaSession(currentPlaylist[currentSongIndex]);
            acquireWakeLock().catch(console.error);
            showPlayer();
            incrementPlayCount(currentPlaylist[currentSongIndex].id).then(
              () => {
                updatePlayCountDisplay(currentPlaylist[currentSongIndex]);
              }
            );
          })
          .catch(handleAudioError);
      }

      // Update play/pause button appearance
      function updatePlayPauseButton() {
        playPauseBtn.textContent = audioPlayer.paused ? "" : "";
        playPauseBtn.classList.toggle("active", !audioPlayer.paused);
      }

      // Handle audio playback errors
      function handleAudioError(e) {
        console.error("Audio playback error:", e);
        if (e.name === "NotAllowedError") {
          console.log("Autoplay prevented. User interaction required.");
          showPlayPrompt();
        } else {
          playNext();
        }
      }

      // Show play prompt when autoplay is prevented
      function showPlayPrompt() {
        const playPrompt = document.createElement("div");
        playPrompt.innerHTML =
          '<button id="startPlayback">Tap to Play</button>';
        document.body.appendChild(playPrompt);
        document
          .getElementById("startPlayback")
          .addEventListener("click", () => {
            audioPlayer
              .play()
              .then(() => {
                playPrompt.remove();
              })
              .catch((e) => console.error("Error starting playback:", e));
          });
      }

      // Toggle play/pause
      function togglePlayPause() {
    if (audioPlayer.paused) {
        audioPlayer.play()
            .then(() => {
                updatePlayPauseButton();
                forceUIUpdate();
            })
            .catch(handleAudioError);
    } else {
        audioPlayer.pause();
        updatePlayPauseButton();
        forceUIUpdate();
    }
}

function forceUIUpdate() {
    const lyricsPlayPauseBtn = document.getElementById('lyricsPlayPauseBtn');
    if (lyricsPlayPauseBtn) {
        lyricsPlayPauseBtn.style.display = 'none';
        setTimeout(() => {
            lyricsPlayPauseBtn.style.display = '';
        }, 0);
    }
}

function updatePlayPauseButton() {
  const mainPlayPauseBtn = document.getElementById('playPauseBtn');
  const lyricsPlayPauseBtn = document.getElementById('lyricsPlayPauseBtn');
  const isPlaying = !audioPlayer.paused;

  [mainPlayPauseBtn, lyricsPlayPauseBtn].forEach(btn => {
    if (btn) {
      btn.innerHTML = isPlaying 
        ? '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' // Pause icon
        : '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>'; // Play icon
    }
  });
}

      // Set up media session for media control integration
      function setupMediaSession(song) {
        if ("mediaSession" in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: song.title,
            artist: "FWMC-AI RADIO",
            album: "AI Covers",
            artwork: [
              { src: song.cover, sizes: "96x96", type: "image/png" },
              { src: song.cover, sizes: "128x128", type: "image/png" },
              { src: song.cover, sizes: "192x192", type: "image/png" },
              { src: song.cover, sizes: "256x256", type: "image/png" },
              { src: song.cover, sizes: "384x384", type: "image/png" },
              { src: song.cover, sizes: "512x512", type: "image/png" },
            ],
          });

          navigator.mediaSession.setActionHandler("play", () =>
            audioPlayer.play()
          );
          navigator.mediaSession.setActionHandler("pause", () =>
            audioPlayer.pause()
          );
          navigator.mediaSession.setActionHandler(
            "previoustrack",
            playPrevious
          );
          navigator.mediaSession.setActionHandler("nexttrack", playNext);
        }
      }

      // Ensure audio keeps playing
      function ensureAudioPlayback() {
        if (!audioPlayer.paused) {
          audioPlayer.play().catch((e) => {
            console.error("Error ensuring audio playback:", e);
            if (e.name !== "NotAllowedError") {
              setTimeout(() => audioPlayer.play(), 1000);
            }
          });
        }
      }

      // Update progress bar and visualizer
      function updateProgressBar() {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.style.width = `${progress}%`;

        // Update time display
        document.getElementById("currentTime").textContent = formatTime(
          audioPlayer.currentTime
        );
        document.getElementById("totalDuration").textContent = formatTime(
          audioPlayer.duration
        );
      }

      // Format time for display
      function formatTime(time) {
        const minutes = Math.floor(time / 60);
        const seconds = Math.floor(time % 60);
        return `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
      }

      // Utility Functions
      function forceButtonRedraw(button) {
        button.style.display = "none";
        button.offsetHeight; // Trigger a reflow
        button.style.display = "";
      }

      // Resize visualizer
      function resizeVisualizer() {
        progressVisualizer.width = progressContainer.clientWidth;
        progressVisualizer.height = progressContainer.clientHeight;
      }

      // Open & Close Donate and Social Modal
      function openDonateSocialsModal() {
        console.log("Opening donate modal");
        document.getElementById("donateSocialsModal").style.display = "block";
      }

      function closeDonateSocialsModal() {
        console.log("Closing donate modal");
        document.getElementById("donateSocialsModal").style.display = "none";
      }

      // Playlist Modal
      function savePlaylist(playlistName, songs) {
        const deviceId = getDeviceId();
        const playlistData = {
          name: playlistName,
          songs: songs,
        };
        console.log(
          `Saving playlist "${playlistName}" to Firebase for device ${deviceId}`
        );
        console.log("Playlist data:", playlistData);
        return firebase
          .database()
          .ref(`playlists/${deviceId}/${playlistName}`)
          .set(playlistData)
          .then(() => {
            console.log(
              `Playlist "${playlistName}" saved successfully to Firebase`
            );
            return true;
          })
          .catch((error) => {
            console.error(
              `Error saving playlist "${playlistName}" to Firebase:`,
              error
            );
            return false;
          });
      }

      function createDefaultPlaylistIfNeeded() {
        return getPlaylists()
          .then((playlists) => {
            // Check if there are any playlists at all, not just for a "Default" playlist
            if (Object.keys(playlists).length === 0) {
              console.log(
                "No playlists found. A default playlist will be created when needed."
              );
              return false; // No need to create a default playlist here
            } else {
              console.log("Playlists already exist");
              return false;
            }
          })
          .catch((error) => {
            console.error("Error checking for existing playlists:", error);
            throw error;
          });
      }

      function goToPlaylist(playlistName) {
        console.log(`Navigating to playlist: ${playlistName}`);
        getPlaylistFromFirebase(playlistName)
          .then((playlist) => {
            if (playlist && playlist.songs && playlist.songs.length > 0) {
              currentPlaylist = playlist.songs;
              currentPlaylistName = playlistName;
              isCustomPlaylistActive = true;
              currentSongIndex = 0;
              displayMainPlaylist(currentPlaylist);
              updateSidebarPlaylist();
              showBackToMainButton();

              // Close the View Playlists modal
              toggleModal("viewPlaylistsModal", false);

              // Optionally, you can scroll to the top of the page
              window.scrollTo(0, 0);
            } else {
              console.error(
                `Playlist "${playlistName}" is empty or does not exist`
              );
              alert("This playlist is empty or does not exist.");
            }
          })
          .catch((error) => {
            console.error(`Error loading playlist "${playlistName}":`, error);
            alert("There was an error loading the playlist. Please try again.");
          });
      }

      function deletePlaylist(name) {
        console.log(`Attempting to delete playlist: ${name}`);
        return deletePlaylistFromFirebase(name)
          .then(() => {
            console.log(`Playlist "${name}" deleted from Firebase`);
            let userPlaylists =
              JSON.parse(localStorage.getItem("userPlaylists")) || {};
            if (userPlaylists[name]) {
              delete userPlaylists[name];
              localStorage.setItem(
                "userPlaylists",
                JSON.stringify(userPlaylists)
              );
              console.log(`Playlist "${name}" removed from local storage`);
              return true;
            }
            return false;
          })
          .catch((error) => {
            console.error("Error deleting playlist from Firebase:", error);
            return false;
          });
      }

      function addSongToPlaylist(playlistName, song) {
        console.log(`Adding song to playlist: ${playlistName}`);
        return getPlaylists()
          .then((playlists) => {
            console.log("Fetched playlists:", playlists);

            if (!playlists[playlistName]) {
              playlists[playlistName] = { name: playlistName, songs: [] };
            } else if (!playlists[playlistName].songs) {
              playlists[playlistName].songs = [];
            }

            console.log(
              `Playlist "${playlistName}" before adding song:`,
              playlists[playlistName].songs
            );

            // Check if the song already exists in the playlist
            if (
              playlists[playlistName].songs.some(
                (existingSong) => existingSong.id === song.id
              )
            ) {
              console.log(`Song already exists in playlist "${playlistName}"`);
              return {
                status: "exists",
                message: "Song already exists in the playlist",
              };
            }

            // Add the song to the playlist
            playlists[playlistName].songs.push(song);
            console.log(
              `Playlist "${playlistName}" after adding song:`,
              playlists[playlistName].songs
            );

            return savePlaylistToFirebase(
              playlistName,
              playlists[playlistName]
            ).then(() => {
              console.log(
                `Song added to playlist "${playlistName}" successfully`
              );
              // Update local cache
              localStorage.setItem("userPlaylists", JSON.stringify(playlists));
              return {
                status: "added",
                message: "Song added to playlist successfully",
              };
            });
          })
          .catch((error) => {
            console.error(
              `Error adding song to playlist "${playlistName}":`,
              error
            );
            return {
              status: "error",
              message: "Error adding song to playlist",
            };
          });
      }

      function playlistExists(playlistName) {
        const playlists = getPlaylists();
        return !!playlists[playlistName];
      }

      function renamePlaylist(oldName, newName) {
        if (oldName === newName) {
          console.log("Playlist name unchanged");
          return Promise.resolve();
        }

        const deviceId = getDeviceId();
        return database
          .ref(`playlists/${deviceId}/${oldName}`)
          .once("value")
          .then((snapshot) => {
            const playlistData = snapshot.val();
            if (!playlistData) {
              throw new Error("Playlist not found");
            }
            return database
              .ref(`playlists/${deviceId}/${newName}`)
              .set(playlistData)
              .then(() =>
                database.ref(`playlists/${deviceId}/${oldName}`).remove()
              );
          })
          .then(() => {
            console.log(`Playlist renamed from "${oldName}" to "${newName}"`);
            // Update local cache
            let userPlaylists =
              JSON.parse(localStorage.getItem("userPlaylists")) || {};
            userPlaylists[newName] = userPlaylists[oldName];
            delete userPlaylists[oldName];
            localStorage.setItem(
              "userPlaylists",
              JSON.stringify(userPlaylists)
            );

            // Update current playlist name if it was the renamed playlist
            if (currentPlaylistName === oldName) {
              currentPlaylistName = newName;
            }

            // Refresh the playlists display
            displayPlaylists();
          })
          .catch((error) => {
            console.error(
              `Error renaming playlist from "${oldName}" to "${newName}":`,
              error
            );
            alert(
              "There was an error renaming the playlist. Please try again."
            );
          });
      }

      function removeSongFromPlaylist(playlistName, songIndex) {
        console.log(
          `Attempting to remove song at index ${songIndex} from playlist "${playlistName}"`
        );
        const deviceId = getDeviceId();
        const playlistRef = database.ref(
          `playlists/${deviceId}/${playlistName}`
        );

        return playlistRef
          .once("value")
          .then((snapshot) => {
            let playlist = snapshot.val();
            console.log(
              `Fetched playlist data for "${playlistName}":`,
              playlist
            );

            if (!playlist) {
              console.error(`Playlist "${playlistName}" does not exist`);
              return Promise.reject(new Error("Playlist does not exist"));
            }

            let songs;
            if (Array.isArray(playlist)) {
              songs = playlist;
            } else if (playlist.songs && Array.isArray(playlist.songs)) {
              songs = playlist.songs;
            } else if (typeof playlist === "object") {
              songs = Object.values(playlist).filter(
                (item) => typeof item === "object" && item.title
              );
            } else {
              console.error(
                `Invalid playlist structure for "${playlistName}":`,
                playlist
              );
              return Promise.reject(new Error("Invalid playlist structure"));
            }

            console.log(`Extracted songs:`, songs);

            if (songIndex < 0 || songIndex >= songs.length) {
              console.error(
                `Invalid song index: ${songIndex}. Playlist length: ${songs.length}`
              );
              return Promise.reject(new Error("Invalid song index"));
            }

            songs = songs.filter((_, index) => index !== songIndex);
            console.log(`Songs after removal:`, songs);

            // Preserve the original structure
            if (Array.isArray(playlist)) {
              playlist = songs;
            } else if (playlist.songs) {
              playlist.songs = songs;
            } else {
              playlist = { name: playlistName, songs: songs };
            }

            return playlistRef.set(playlist).then(() => {
              console.log(`Updated playlist in Firebase`);
              return songs;
            });
          })
          .then((updatedSongs) => {
            console.log(
              `Song removed from playlist "${playlistName}" successfully`
            );
            console.log(`Updated songs:`, updatedSongs);

            if (currentPlaylistName === playlistName) {
              currentPlaylist = updatedSongs;
              console.log(`Updated currentPlaylist:`, currentPlaylist);
            }

            updatePlaylistDisplay(playlistName, updatedSongs);
            updateSidebarPlaylist();

            return getPlaylistsFromFirebase().then((playlists) => {
              console.log(`All playlists after update:`, playlists);
              localStorage.setItem("userPlaylists", JSON.stringify(playlists));
              displayPlaylists(true);
              return true;
            });
          })
          .catch((error) => {
            console.error(
              `Error removing song from playlist "${playlistName}":`,
              error
            );
            throw error;
          });
      }

      function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (show) {
          modal.style.display = "block";
          setTimeout(() => (modal.style.opacity = "1"), 10);
        } else {
          modal.style.opacity = "0";
          setTimeout(() => {
            modal.style.display = "none";
          }, 300);
        }
      }

      // Sync Options Modal
      function setupSyncOptionsModal() {
        const syncOptionsBtn = document.getElementById("syncOptionsBtn");
        const syncOptionsModal = document.getElementById("syncOptionsModal");
        const closeSyncOptionsModalBtn = document.getElementById(
          "closeSyncOptionsModalBtn"
        );

        if (syncOptionsBtn) {
          syncOptionsBtn.addEventListener("click", () => {
            updateDeviceIdDisplay();
            toggleModal("syncOptionsModal", true);
          });
        }

        if (closeSyncOptionsModalBtn) {
          closeSyncOptionsModalBtn.addEventListener("click", () => {
            toggleModal("syncOptionsModal", false);
          });
        }

        // Set up the copy button
        setupCopyButton();
      }

      function updateDeviceIdDisplay() {
        const deviceId = getDeviceId();
        const uniquePart = deviceId.replace("device_", "");
        const deviceIdDisplay = document.getElementById("deviceIdDisplay");
        if (deviceIdDisplay) {
          deviceIdDisplay.textContent = `Your Device ID: ${uniquePart}`;
        }

        const instructions = document.getElementById("syncInstructions");
        if (instructions) {
          instructions.textContent =
            "Use this Device ID to recover playlists or sync your playlists on other devices. Screenshot or copy this ID to a safe place and enter it below if you ever lose your playlists.";
        }
      }

      function setupCopyButton() {
        const copyBtn = document.getElementById("copyDeviceIdBtn");

        if (copyBtn) {
          copyBtn.addEventListener("touchend", handleCopy, { passive: false });
          copyBtn.addEventListener("click", handleCopy);
        }
      }

      function handleCopy(event) {
        event.preventDefault();
        event.stopPropagation();

        const deviceId = getDeviceId().replace("device_", "");
        copyToClipboard(deviceId);

        // Prevent default for a longer duration
        setTimeout(() => {}, 100);
      }

      function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(text)
            .then(() => showCopySuccess())
            .catch(() => showCopyFailure());
        } else {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-999999px";
          textArea.style.top = "0";
          textArea.style.opacity = "0";

          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            const successful = document.execCommand("copy");
            successful ? showCopySuccess() : showCopyFailure();
          } catch (err) {
            console.error("Copy failed:", err);
            showCopyFailure();
          } finally {
            document.body.removeChild(textArea);
          }
        }
      }

      function showCopySuccess() {
        showNotification("Device ID copied to clipboard", "info");
      }

      function showCopyFailure() {
        showNotification(
          "Failed to copy Device ID. Please copy it manually.",
          "error"
        );
      }

      function displayDeviceId() {
        const deviceId = getDeviceId();
        const uniquePart = deviceId.replace("device_", "");
        const deviceIdDisplay = document.getElementById("deviceIdDisplay");
        if (deviceIdDisplay) {
          deviceIdDisplay.textContent = `Your Device ID: ${uniquePart}`;
        }

        const instructions = document.getElementById("syncInstructions");
        if (instructions) {
          instructions.textContent =
            "Use this Device ID to recover playlists or sync your playlists on other devices. Screenshot or copy this ID to a safe place and enter it below if you ever lose your playlists.";
        }

        // Set up copy button
        setupCopyButton();
      }

      // Show Playlist-related event listeners
      function setupSidebarScroll() {
        const sidebar = document.getElementById("playlistSidebar");
        const header = sidebar.querySelector(".sidebar-header");

        sidebar.addEventListener("scroll", () => {
          if (sidebar.scrollTop > 0) {
            header.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
          } else {
            header.style.boxShadow = "none";
          }
        });
        document
          .getElementById("syncPlaylistsBtn")
          .addEventListener("click", syncPlaylists);
        displayDeviceId();
      }

      // Set up event listeners
      function setupEventListeners() {
        // Audio player event listeners
        audioPlayer.addEventListener("ended", () => {
          if (isRepeatOn) {
            audioPlayer.currentTime = 0;
            audioPlayer.play();
          } else {
            try {
              playNext();
            } catch (error) {
              console.error("Error playing next song:", error);
            }
          }
        });       

  audioPlayer.addEventListener('play', () => {
        if (document.getElementById('lyricsModal').style.display === 'block') {
            updateLyricsModal();
        }
    });

    shuffleBtn.addEventListener("touchend", function (e) {
        e.preventDefault(); // Prevent any default touch behavior
        shufflePlaylist();
    });

        audioPlayer.addEventListener("timeupdate", updateProgressBar);

        // Control buttons
        nextBtn.addEventListener("click", playNext);
        prevBtn.addEventListener("click", playPrevious);
        playPauseBtn.addEventListener("click", togglePlayPause);
        searchBtn.addEventListener("click", searchSongs);
        shuffleBtn.addEventListener("click", shufflePlaylist);
        showPlaylistBtn.addEventListener("click", togglePlaylist);
        closePlaylistBtn.addEventListener("click", togglePlaylist);
        setupSyncOptionsModal();

        // Progress and volume
        progressContainer.addEventListener("click", setProgress);

        // Volume control event listener
        volumeControl.addEventListener("input", () => {
          const volume = volumeControl.value;
          audioPlayer.volume = volume;
        });

        // Initialize volume control on page load
        document.addEventListener("DOMContentLoaded", () => {
          const initialVolume = audioPlayer.volume;
          volumeControl.value = initialVolume;
        });

        // Playlist toggle event listeners
        togglePlayerBtn.addEventListener("click", togglePlayer);
        backToMainBtn.addEventListener("click", backToMainPlaylist);

        // Playlist-related event listeners
        document
          .getElementById("createPlaylistBtn")
          .addEventListener("click", () =>
            toggleModal("createPlaylistModal", true)
          );
        document
          .getElementById("viewPlaylistsBtn")
          .addEventListener("click", () => {
            console.log("View Playlists button clicked");
            getPlaylistsFromFirebase() // Fetch the latest data from Firebase
              .then((playlists) => {
                localStorage.setItem(
                  "userPlaylists",
                  JSON.stringify(playlists)
                );
                displayPlaylists(true); // Force a refresh of the playlists display
                toggleModal("viewPlaylistsModal", true);
              })
              .catch((error) => {
                console.error("Error fetching playlists:", error);
                alert(
                  "There was an error loading your playlists. Please try again."
                );
              });
          });
        document
          .getElementById("saveNewPlaylistBtn")
          .addEventListener("click", createPlaylist);
        document
          .getElementById("closeCreatePlaylistModalBtn")
          .addEventListener("click", () =>
            toggleModal("createPlaylistModal", false)
          );
        document
          .getElementById("closeViewPlaylistsModalBtn")
          .addEventListener("click", () =>
            toggleModal("viewPlaylistsModal", false)
          );
        document
          .getElementById("closeAddToPlaylistModalBtn")
          .addEventListener("click", () =>
            toggleModal("addToPlaylistModal", false)
          );
        document.getElementById("refreshPlaylistsBtn").textContent =
          "Fetch Playlists";
        document
          .getElementById("refreshPlaylistsBtn")
          .addEventListener("click", refreshPlaylists);

        // Donate & Socials Modal
        const showDonateSocialsBtn = document.getElementById(
          "showDonateSocialsBtn"
        );
        const closeModalBtn = document.getElementById("closeModalBtn");
        const donateSocialsModal =
          document.getElementById("donateSocialsModal");

        if (showDonateSocialsBtn) {
          showDonateSocialsBtn.addEventListener(
            "click",
            openDonateSocialsModal
          );
        }

        if (closeModalBtn) {
          closeModalBtn.addEventListener("click", closeDonateSocialsModal);
        }

        // Close modals when clicking outside
        window.addEventListener("click", (event) => {
          if (event.target.classList.contains("donate-modal")) {
            closeDonateSocialsModal();
          } else if (event.target.classList.contains("playlist-modal")) {
            toggleModal(event.target.id, false);
          }
        });

        // Visibility change listener
        document.addEventListener("visibilitychange", handleVisibilityChange);

        // Android optimization
        if (isAndroid()) {
          window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            let deferredPrompt = e;
            const addToHomeScreenBtn =
              document.getElementById("addToHomeScreenBtn");
            if (addToHomeScreenBtn) {
              addToHomeScreenBtn.style.display = "block";
              addToHomeScreenBtn.addEventListener("click", (e) => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === "accepted") {
                    console.log("User accepted the A2HS prompt");
                  } else {
                    console.log("User dismissed the A2HS prompt");
                  }
                  deferredPrompt = null;
                });
              });
            }
          });
        }

        window.matchMedia("(display-mode: standalone)").addListener((evt) => {
          updateEnterButtonText();
        });
        document
          .getElementById("syncPlaylistsBtn")
          .addEventListener("click", syncPlaylists);

        console.log("All event listeners set up successfully");
      }

      // Set progress when clicking on progress bar
      function setProgress(e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audioPlayer.duration;
        audioPlayer.currentTime = (clickX / width) * duration;
      }

      function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (show) {
          modal.style.display = "block";
          setTimeout(() => (modal.style.opacity = "1"), 10);
        } else {
          modal.style.opacity = "0";
          setTimeout(() => {
            modal.style.display = "none";
          }, 300);
        }
      }

      // Show Playlist-related event listeners
      function setupSidebarScroll() {
        const sidebar = document.getElementById("playlistSidebar");
        const header = sidebar.querySelector(".sidebar-header");

        sidebar.addEventListener("scroll", () => {
          if (sidebar.scrollTop > 0) {
            header.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
          } else {
            header.style.boxShadow = "none";
          }
        });
      }

      // Insert the drag-and-drop functions here
      function setupPlaylistSongsDragAndDrop() {
        const playlistSongs = document.querySelectorAll(".playlist-songs");
        playlistSongs.forEach((playlist) => {
          playlist.addEventListener("dragstart", handlePlaylistSongDragStart);
          playlist.addEventListener("dragover", handlePlaylistSongDragOver);
          playlist.addEventListener("drop", handlePlaylistSongDrop);
          playlist.addEventListener("dragend", handlePlaylistSongDragEnd);
        });
      }

      function handlePlaylistSongDragStart(e) {
        if (!e.target.matches("li")) return;
        e.dataTransfer.setData("text/plain", e.target.dataset.index);
        e.target.classList.add("dragging");
      }

      function handlePlaylistSongDragOver(e) {
        e.preventDefault();
        const draggingElement = e.currentTarget.querySelector(".dragging");
        if (!draggingElement) return;
        const closestElement = getClosestPlaylistSongElement(
          e.currentTarget,
          e.clientY
        );
        if (closestElement) {
          e.currentTarget.insertBefore(draggingElement, closestElement);
        } else {
          e.currentTarget.appendChild(draggingElement);
        }
      }

      function handlePlaylistSongDrop(e) {
        e.preventDefault();
        const playlistName = e.currentTarget.dataset.playlist;
        const fromIndex = parseInt(e.dataTransfer.getData("text"));
        const toIndex = Array.from(e.currentTarget.children).indexOf(
          e.currentTarget.querySelector(".dragging")
        );
        if (fromIndex !== toIndex && fromIndex !== -1 && toIndex !== -1) {
          reorderPlaylistSong(playlistName, fromIndex, toIndex)
            .then(() => {
              console.log(`Playlist "${playlistName}" reordered successfully`);
              // The UI should already be updated by reorderPlaylistSong
              // But we can add any additional UI updates here if needed
            })
            .catch((error) => {
              console.error(
                `Error reordering playlist "${playlistName}":`,
                error
              );
              alert(
                "An error occurred while reordering the playlist. Please try again."
              );
              // Refresh the playlist display to ensure it's in the correct order
              displayPlaylists();
            });
        }
      }

      function handlePlaylistSongDragEnd(e) {
        e.target.classList.remove("dragging");
      }

      function getClosestPlaylistSongElement(playlist, y) {
        const draggableElements = [
          ...playlist.querySelectorAll("li:not(.dragging)"),
        ];
        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      function reorderPlaylistSong(playlistName, fromIndex, toIndex) {
        console.log(
          `Reordering song in playlist "${playlistName}" from index ${fromIndex} to ${toIndex}`
        );

        const deviceId = getDeviceId();
        return database
          .ref(`playlists/${deviceId}/${playlistName}`)
          .once("value")
          .then((snapshot) => {
            let playlist = snapshot.val();
            if (!playlist) {
              throw new Error("Playlist not found");
            }

            let songs;
            if (Array.isArray(playlist)) {
              songs = playlist;
            } else if (playlist.songs && Array.isArray(playlist.songs)) {
              songs = playlist.songs;
            } else if (typeof playlist === "object") {
              songs = Object.values(playlist).filter(
                (item) => typeof item === "object" && item.title
              );
            } else {
              throw new Error("Invalid playlist structure");
            }

            if (
              fromIndex < 0 ||
              fromIndex >= songs.length ||
              toIndex < 0 ||
              toIndex >= songs.length
            ) {
              throw new Error("Invalid index");
            }

            // Perform the reorder
            const [movedSong] = songs.splice(fromIndex, 1);
            songs.splice(toIndex, 0, movedSong);

            // Preserve the entire playlist structure
            if (Array.isArray(playlist)) {
              playlist = songs;
            } else if (playlist.songs) {
              playlist.songs = songs;
            } else {
              playlist = { name: playlistName, songs: songs };
            }

            console.log("Reordered playlist structure:", playlist);
            // Update Firebase with the entire playlist structure
            return database
              .ref(`playlists/${deviceId}/${playlistName}`)
              .set(playlist)
              .then(() => {
                console.log(
                  `Playlist "${playlistName}" reordered and saved successfully`
                );

                // Update local state if it's the current playlist
                if (playlistName === currentPlaylistName) {
                  currentPlaylist = songs;

                  // Update currentSongIndex if necessary
                  if (currentSongIndex === fromIndex) {
                    currentSongIndex = toIndex;
                  } else if (
                    fromIndex < currentSongIndex &&
                    toIndex >= currentSongIndex
                  ) {
                    currentSongIndex--;
                  } else if (
                    fromIndex > currentSongIndex &&
                    toIndex <= currentSongIndex
                  ) {
                    currentSongIndex++;
                  }

                  // Update shuffled playlist if necessary
                  if (isShuffled) {
                    const currentSong = shuffledPlaylist[0];
                    shuffledPlaylist = [
                      currentSong,
                      ...songs.filter((song) => song.id !== currentSong.id),
                    ];
                    shuffledPlaylist.sort(() => Math.random() - 0.5);
                    shuffledPlaylist.unshift(
                      shuffledPlaylist.splice(
                        shuffledPlaylist.findIndex(
                          (song) => song.id === currentSong.id
                        ),
                        1
                      )[0]
                    );
                  }

                  // Update UI with a small delay
                  setTimeout(() => {
                    console.log("Updating main playlist view after reorder");
                    displayMainPlaylist(
                      isShuffled ? shuffledPlaylist : currentPlaylist
                    );
                  }, 100);
                }

                // Update the playlist display in the "View Playlists" modal
                console.log("Updating View Playlists modal after reorder");
                updatePlaylistDisplay(playlistName, songs);

                // Update sidebar if open
                if (playlistSidebar.classList.contains("open")) {
                  console.log("Updating sidebar playlist after reorder");
                  updateSidebarPlaylist();
                }

                return songs;
              });
          })
          .catch((error) => {
            console.error(
              `Error reordering playlist "${playlistName}":`,
              error
            );
            throw error;
          });
      }

      function updateSidebarPlaylist(filteredPlaylist = null) {
        const fullPlaylist = document.getElementById("fullPlaylist");
        if (fullPlaylist) {
          fullPlaylist.innerHTML = "";
          const displayPlaylist =
            filteredPlaylist ||
            (isShuffled ? shuffledPlaylist : currentPlaylist);
          displayPlaylist.forEach((song, index) => {
            const li = document.createElement("li");
            li.innerHTML = `
                ${
                  currentPlaylistName !== "main" &&
                  currentPlaylistName !== "search"
                    ? '<span class="drag-handle"><i class="fas fa-grip-lines"></i></span>'
                    : '<span class="spacer"></span>'
                }
                <span class="song-title">${song.title}</span>
            `;
            li.dataset.index = index;
            li.draggable =
              currentPlaylistName !== "main" &&
              currentPlaylistName !== "search";
            li.addEventListener("click", (e) => {
              if (!e.target.closest(".drag-handle")) {
                playSong(index);
              }
            });
            if (index === currentSongIndex) {
              li.classList.add("playing");
            }
            fullPlaylist.appendChild(li);
          });
        }
      }

      function playNext() {
        const playlist = isShuffled ? shuffledPlaylist : currentPlaylist;
        if (playlist && playlist.length > 0) {
          currentSongIndex = (currentSongIndex + 1) % playlist.length;
          playSong(currentSongIndex);
        } else {
          console.error("No valid playlist available");
        }
      }

      function playPrevious() {
        const playlist = isShuffled ? shuffledPlaylist : currentPlaylist;
        if (playlist && playlist.length > 0) {
          if (audioPlayer.currentTime > 3) {
            audioPlayer.currentTime = 0;
          } else {
            currentSongIndex =
              (currentSongIndex - 1 + playlist.length) % playlist.length;
            playSong(currentSongIndex);
          }
        } else {
          console.error("No valid playlist available");
        }
      }

      function updateLyricsModal() {
    const currentSong = isShuffled ? shuffledPlaylist[currentSongIndex] : currentPlaylist[currentSongIndex];
    const lyricsSongTitle = document.getElementById('lyricsSongTitle');
    const lyricsContent = document.getElementById('lyricsContent');
    const lyricsBackground = document.querySelector('.lyrics-background');
    const lyricsPlayerControls = document.getElementById('lyricsPlayerControls');

    lyricsSongTitle.textContent = currentSong.title;
    lyricsContent.textContent = 'Loading lyrics...';
    lyricsBackground.style.backgroundImage = `url('${currentSong.cover}')`;

    // Transfer media player controls, excluding the lyrics button
    const mainPlayerControls = document.querySelector('.player-container .player-controls');
    lyricsPlayerControls.innerHTML = mainPlayerControls.innerHTML;

    // Correct the ID of the play/pause button in the lyrics modal
    const lyricsPlayPauseBtn = lyricsPlayerControls.querySelector('#playPauseBtn');
    if (lyricsPlayPauseBtn) {
        lyricsPlayPauseBtn.id = 'lyricsPlayPauseBtn';
        lyricsPlayPauseBtn.innerHTML = `
            <svg viewBox="0 0 24 24" width="24" height="24" class="play-icon">
                <path fill="currentColor" d="M8 5v14l11-7z" />
            </svg>
            <svg viewBox="0 0 24 24" width="24" height="24" class="pause-icon">
                <path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
        `;
        lyricsPlayPauseBtn.classList.add(audioPlayer.paused ? 'play' : 'pause');
    }

    const lyricsButtonInModal = lyricsPlayerControls.querySelector('#lyricsBtn');
    if (lyricsButtonInModal) {
        lyricsButtonInModal.remove();
    }

    // Re-attach event listeners to the transferred controls
    attachControlListeners(lyricsPlayerControls);

    // Update button states
    updatePlayPauseButton();
    updateRepeatButtonState();

    if (!lyricsContent.textContent || lyricsContent.textContent === 'Loading lyrics...') {
        const lyricsFile = currentSong.syncedLyrics || currentSong.lyrics;
        if (lyricsFile) {
            fetch(lyricsFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Lyrics file not found');
                    }
                    return response.text();
                })
                .then(text => {
                    console.log("Lyrics fetched successfully");
                    if (currentSong.syncedLyrics) {
                        displaySyncedLyrics(text);
                    } else {
                        lyricsContent.textContent = text;
                    }
                })
                .catch(error => {
                    console.error('Error fetching lyrics:', error);
                    lyricsContent.textContent = `Lyrics not yet available for "${currentSong.title}".`;
                });
        } else {
            console.log("No lyrics file found for this song");
            lyricsContent.textContent = `Lyrics not yet available for "${currentSong.title}".`;
        }
    }
}

      function playSong(index) {
        // Reset repeat state when a new song is played
        isRepeatOn = false;
        updateRepeatButtonState();
        const playlist = isShuffled ? shuffledPlaylist : currentPlaylist;
        if (index < 0 || index >= playlist.length) {
          console.error(
            `Invalid song index: ${index}. Playlist length: ${playlist.length}`
          );
          return;
        }

        currentSongIndex = index;
        const song = playlist[currentSongIndex];

        if (!song || !song.file) {
          console.error(`Invalid song object at index ${index}:`, song);
          return;
        }

        console.log(`Playing song: ${song.title}`);
        audioPlayer.src = song.file;
        audioPlayer.load();
        audioPlayer
          .play()
          .then(() => {
            userPaused = false;
            updateSongInfo(song);
            updatePlayPauseButton();
            updateSidebarPlaylist();
            setupMediaSession(song);
            acquireWakeLock().catch(console.error);
            showPlayer();
            incrementPlayCount(song.id).then(() => {
              updatePlayCountDisplay(song);
              
            });
          })
          .catch(handleAudioError);
          
      }

      function setupPlayerControls() {
        const skip10BackBtn = document.getElementById("skip10BackBtn");
        const skip10AheadBtn = document.getElementById("skip10AheadBtn");
        const repeatBtn = document.getElementById("repeatBtn");

        function addButtonListeners(button, clickHandler) {
          button.addEventListener("click", clickHandler);
          button.addEventListener("touchend", preventZoom);
        }

        addButtonListeners(skip10BackBtn, () => skipTime(-10));
        addButtonListeners(skip10AheadBtn, () => skipTime(10));
        addButtonListeners(repeatBtn, toggleRepeat);
      }

      function preventZoom(e) {
        var t2 = e.timeStamp;
        var t1 = e.currentTarget.dataset.lastTouch || t2;
        var dt = t2 - t1;
        var fingers = e.touches.length;
        e.currentTarget.dataset.lastTouch = t2;

        if (!dt || dt > 500 || fingers > 1) return; // Not double-tap

        e.preventDefault();
        e.target.click();
      }

      function skipTime(seconds) {
        audioPlayer.currentTime += seconds;
      }

      function toggleRepeat() {
        isRepeatOn = !isRepeatOn;
        const repeatBtn = document.getElementById("repeatBtn");
        repeatBtn.classList.toggle("active", isRepeatOn);
        updateRepeatButtonState();
      }

      function updateRepeatButtonState() {
  const mainRepeatBtn = document.getElementById("repeatBtn");
  const lyricsRepeatBtn = document.getElementById("lyricsRepeatBtn");
  
  [mainRepeatBtn, lyricsRepeatBtn].forEach(btn => {
    if (btn) {
      btn.title = isRepeatOn ? "Repeat: On" : "Repeat: Off";
      btn.classList.toggle("active", isRepeatOn);
    }
  });
}

      function updatePlaylistDisplay(playlistName, updatedPlaylist) {
        console.log(
          `Updating display for playlist "${playlistName}"`,
          updatedPlaylist
        );

        if (!updatedPlaylist || !Array.isArray(updatedPlaylist)) {
          console.error(
            `Invalid playlist data for "${playlistName}"`,
            updatedPlaylist
          );
          return;
        }

        // Update the main playlist view if it's the current playlist
        if (currentPlaylistName === playlistName) {
          console.log(`Updating main playlist view for "${playlistName}"`);
          displayMainPlaylist(updatedPlaylist);
        }

        // Update the playlist in the "View Playlists" modal
        const playlistElement = document.querySelector(
          `#playlistsList li:has(.playlist-songs[data-playlist="${playlistName}"])`
        );
        if (playlistElement) {
          console.log(`Updating View Playlists modal for "${playlistName}"`);
          const songsList = playlistElement.querySelector(".playlist-songs");
          const songCount = playlistElement.querySelector(".song-count");

          // Clear existing content
          songsList.innerHTML = "";

          // Rebuild the song list with the updated order
          updatedPlaylist.forEach((song, index) => {
            const li = document.createElement("li");
            li.draggable = true;
            li.dataset.index = index;
            li.innerHTML = `
                <span class="drag-handle"></span>
                ${song.title || "Untitled Song"}
                <button class="delete-song-btn btn" data-playlist="${playlistName}" data-index="${index}">Remove</button>
            `;
            songsList.appendChild(li);
          });

          songCount.textContent = `(${updatedPlaylist.length} songs)`;

          // Re-apply drag and drop functionality
          setupPlaylistSongsDragAndDrop();
        } else {
          console.warn(
            `Playlist element for "${playlistName}" not found in View Playlists modal`
          );
        }

        // Update the sidebar playlist if it's open
        if (playlistSidebar.classList.contains("open")) {
          console.log(`Updating sidebar playlist for "${playlistName}"`);
          updateSidebarPlaylist();
        }

        console.log(`Playlist display update complete for "${playlistName}"`);
      }

      // Save Playlists to Firebase -- Saves user playlists across updates
      // Generate a unique device ID
      function getDeviceId() {
        let deviceId = localStorage.getItem("deviceId");
        if (!deviceId) {
          const knownIds = getAllKnownDeviceIds();
          if (knownIds.length > 0) {
            deviceId = knownIds[knownIds.length - 1];
          } else {
            deviceId = "device_" + Math.random().toString(36).substr(2, 9);
            // Increment the user count
            incrementUserCount();
          }
          localStorage.setItem("deviceId", deviceId);
        }
        addKnownDeviceId(deviceId);
        return deviceId;
      }

      function incrementUserCount() {
        firebase
          .database()
          .ref("userCount")
          .transaction((currentCount) => {
            return (currentCount || 0) + 1;
          });
      }

      function getAllKnownDeviceIds() {
        return JSON.parse(localStorage.getItem("knownDeviceIds") || "[]");
      }

      function addKnownDeviceId(deviceId) {
        const knownIds = getAllKnownDeviceIds();
        if (!knownIds.includes(deviceId)) {
          knownIds.push(deviceId);
          localStorage.setItem("knownDeviceIds", JSON.stringify(knownIds));
        }
      }

      function displayDeviceId() {
        const deviceId = getDeviceId();
        const uniquePart = deviceId.replace("device_", "");
        const deviceIdDisplay = document.getElementById("deviceIdDisplay");
        deviceIdDisplay.textContent = `Your Device ID: ${uniquePart}`;

        const instructions = document.getElementById("syncInstructions");
        instructions.textContent =
          "Use this Device ID to recover playlists or sync your playlists on other devices.";
      }

      function syncPlaylists() {
        let syncDeviceId = document
          .getElementById("syncDeviceIdInput")
          .value.trim();
        if (!syncDeviceId) {
          showNotification("Please enter a valid Device ID", "error");
          return;
        }

        // Add 'device_' prefix if it's not present
        if (!syncDeviceId.startsWith("device_")) {
          syncDeviceId = "device_" + syncDeviceId;
        }

        console.log(
          `Attempting to sync playlists from Device ID: ${syncDeviceId}`
        );

        firebase
          .database()
          .ref(`playlists/${syncDeviceId}`)
          .once("value")
          .then((snapshot) => {
            const syncedPlaylists = snapshot.val();
            if (!syncedPlaylists || Object.keys(syncedPlaylists).length === 0) {
              throw new Error("No playlists found for the given Device ID");
            }

            // Update the current device ID
            updateDeviceId(syncDeviceId);

            // Merge playlists, giving priority to existing playlists
            const currentPlaylists =
              JSON.parse(localStorage.getItem("userPlaylists")) || {};
            const mergedPlaylists = { ...syncedPlaylists, ...currentPlaylists };

            // Update Firebase with merged playlists
            return firebase
              .database()
              .ref(`playlists/${syncDeviceId}`)
              .set(mergedPlaylists)
              .then(() => mergedPlaylists);
          })
          .then((mergedPlaylists) => {
            console.log("Playlists merged successfully:", mergedPlaylists);
            localStorage.setItem(
              "userPlaylists",
              JSON.stringify(mergedPlaylists)
            );
            showNotification("Playlists synced successfully", "info");
            return displayPlaylists(true);
          })
          .then(() => {
            if (
              currentPlaylistName !== "main" &&
              currentPlaylistName !== "search"
            ) {
              return getPlaylistFromFirebase(currentPlaylistName).then(
                (updatedPlaylist) => {
                  if (updatedPlaylist && updatedPlaylist.songs) {
                    currentPlaylist = updatedPlaylist.songs;
                    displayMainPlaylist(currentPlaylist);
                    updateSidebarPlaylist();
                  }
                }
              );
            }
          })
          .catch((error) => {
            console.error("Error syncing playlists:", error);
            showNotification(
              "Error syncing playlists. Please try again.",
              "error"
            );
          });
      }

      function updateDeviceId(newDeviceId) {
        // Update localStorage
        localStorage.setItem("deviceId", newDeviceId);

        // Update displayed device ID
        const uniquePart = newDeviceId.replace("device_", "");
        const deviceIdDisplay = document.getElementById("deviceIdDisplay");
        if (deviceIdDisplay) {
          deviceIdDisplay.textContent = `Your Device ID: ${uniquePart}`;
        }

        // Add to known device IDs if not already present
        addKnownDeviceId(newDeviceId);

        console.log(`Device ID updated to: ${newDeviceId}`);

        // Refresh playlists for the new device ID
        refreshPlaylists();
      }

      // Save playlist to Firebase
      function savePlaylistToFirebase(name, playlistData) {
        const deviceId = getDeviceId();
        console.log(
          `Saving playlist "${name}" to Firebase for device ${deviceId}`
        );
        console.log("Original playlist data:", playlistData);

        // Ensure the correct structure
        const formattedPlaylist = {
          name: name,
          songs: Array.isArray(playlistData.songs) ? playlistData.songs : [],
        };

        console.log("Formatted playlist data:", formattedPlaylist);

        return firebase
          .database()
          .ref(`playlists/${deviceId}/${name}`)
          .set(formattedPlaylist)
          .then(() => {
            console.log(`Playlist "${name}" saved successfully to Firebase`);
            return true;
          })
          .catch((error) => {
            console.error(
              `Error saving playlist "${name}" to Firebase:`,
              error
            );
            throw error;
          });
      }

      // Delete playlist from Firebase
      function deletePlaylistFromFirebase(name) {
        const deviceId = getDeviceId();
        return database.ref(`playlists/${deviceId}/${name}`).remove();
      }

      // Update Enter Button
      function updateEnterButtonText() {
        const enterButton = document.getElementById("enterSiteBtn");
        const defaultText = enterButton.getAttribute("data-default-text");

        // Check if the app is running in standalone mode
        const isStandalone =
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone ||
          document.referrer.includes("android-app://");

        if (isStandalone) {
          enterButton.textContent = "Enter App";
        } else {
          enterButton.textContent = defaultText;
        }
      }

      // Song Play Count Auto Update
      function setupIndividualPlayCountListeners() {
        database.ref("playCounts").on("value", (snapshot) => {
          const playCounts = snapshot.val();
          updateAllPlayCounts(playCounts);
        });
      }

      function updateAllPlayCounts(playCounts) {
        const songElements = document.querySelectorAll(".song");
        songElements.forEach((songElement) => {
          const songId = songElement.dataset.id;
          const playCountSpan = songElement.querySelector(".play-count");
          if (playCountSpan && playCounts[songId]) {
            updatePlayCountWithAnimation(playCountSpan, playCounts[songId]);
          }
        });
      }

      function updatePlayCountWithAnimation(element, newCount) {
        const currentCount = parseInt(element.textContent.split(": ")[1]);
        if (newCount !== currentCount) {
          element.classList.add("ticker-transition", "ticker-hidden");
          setTimeout(() => {
            element.textContent = `Plays: ${newCount}`;
            element.classList.remove("ticker-hidden");
          }, 500);
        }
      }

      function initializeUserCount() {
        console.log("Initializing user count...");
        return firebase
          .database()
          .ref("playlists")
          .once("value")
          .then((snapshot) => {
            const playlists = snapshot.val();
            const count = playlists ? Object.keys(playlists).length : 0;
            console.log("Initial user count:", count);
            return firebase.database().ref("userCount").set(count);
          })
          .then(() => {
            console.log("User count initialized successfully");
          })
          .catch((error) => {
            console.error("Error initializing user count:", error);
          });
      }

      function getApproximateUserCount() {
        console.log("Getting approximate user count...");
        return firebase
          .database()
          .ref("userCount")
          .once("value")
          .then((snapshot) => {
            const count = snapshot.val() || 0;
            console.log("Approximate user count:", count);
            return count;
          });
      }

      function updateApproximateUserCount() {
        getApproximateUserCount().then((count) => {
          const approximateUsersElement =
            document.getElementById("approximateUsers");
          if (approximateUsersElement) {
            approximateUsersElement.classList.add(
              "ticker-transition",
              "ticker-hidden"
            );

            setTimeout(() => {
              approximateUsersElement.textContent = `from approximately ${count.toLocaleString()} users`;
              approximateUsersElement.classList.remove("ticker-hidden");
            }, 500);
          }
        });
      }

      function setupApproximateUserCountListener() {
        console.log("Setting up approximate user count listener...");
        firebase
          .database()
          .ref("userCount")
          .on("value", (snapshot) => {
            console.log(
              "User count changed, updating approximate user count..."
            );
            if (snapshot.exists()) {
              updateApproximateUserCount();
            } else {
              console.log("userCount node does not exist, reinitializing...");
              initializeUserCount().then(updateApproximateUserCount);
            }
          });
      }

      function setupLyricsControls() {
  const lyricsModal = document.getElementById('lyricsModal');
  if (!lyricsModal) {
    console.warn('Lyrics modal not found');
    return;
  }

  const lyricsPrevBtn = lyricsModal.querySelector('#lyricsPrevBtn');
  const lyricsPlayPauseBtn = lyricsModal.querySelector('#lyricsPlayPauseBtn');
  const lyricsNextBtn = lyricsModal.querySelector('#lyricsNextBtn');

  if (lyricsPrevBtn) {
    lyricsPrevBtn.addEventListener('click', playPrevious);
  }

  if (lyricsPlayPauseBtn) {
    lyricsPlayPauseBtn.addEventListener('click', () => {
      togglePlayPause();
      updatePlayPauseButton();
    });
  }

  if (lyricsNextBtn) {
    lyricsNextBtn.addEventListener('click', playNext);
  }
}

function setupLyricsButtons() {
    const mainLyricsBtn = document.getElementById('lyricsBtn');
    const closeLyricsBtn = document.getElementById('closeLyricsBtn');

    if (mainLyricsBtn) {
        mainLyricsBtn.addEventListener('click', showLyrics);
    }

    if (closeLyricsBtn) {
        closeLyricsBtn.addEventListener('click', hideLyrics);
    }
}

function updatePlayPauseButton() {
  const mainPlayPauseBtn = document.getElementById('playPauseBtn');
  const lyricsPlayPauseBtn = document.getElementById('lyricsPlayPauseBtn');
  const isPlaying = !audioPlayer.paused;

  [mainPlayPauseBtn, lyricsPlayPauseBtn].forEach(btn => {
    if (btn) {
      btn.innerHTML = isPlaying 
        ? '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' // Pause icon
        : '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>'; // Play icon
    }
  });
}

function showLyrics() {
  console.log("Toggling lyrics visibility");
  const lyricsModal = document.getElementById('lyricsModal');
  const lyricsBtn = document.getElementById('lyricsBtn');

  if (lyricsModal.style.display === 'block') {
    hideLyrics();
    lyricsBtn.title = 'Show Lyrics';
  } else {
    updateLyricsModal();
    lyricsModal.style.display = 'block';
    lyricsBtn.title = 'Hide Lyrics';
    updatePlayPauseButton(); // Update both main and lyrics play/pause buttons
    updateRepeatButtonState();
  }
}

function updateLyricsModal() {
    const currentSong = isShuffled ? shuffledPlaylist[currentSongIndex] : currentPlaylist[currentSongIndex];
    const lyricsSongTitle = document.getElementById('lyricsSongTitle');
    const lyricsContent = document.getElementById('lyricsContent');
    const lyricsBackground = document.querySelector('.lyrics-background');
    const lyricsPlayerControls = document.getElementById('lyricsPlayerControls');

    lyricsSongTitle.textContent = currentSong.title;
    lyricsContent.textContent = 'Loading lyrics...';
    lyricsBackground.style.backgroundImage = `url('${currentSong.cover}')`;

    // Transfer media player controls, excluding the lyrics button
    const mainPlayerControls = document.querySelector('.player-container .player-controls');
    lyricsPlayerControls.innerHTML = mainPlayerControls.innerHTML;
    const lyricsButtonInModal = lyricsPlayerControls.querySelector('#lyricsBtn');
    if (lyricsButtonInModal) {
        lyricsButtonInModal.remove();
    }

    // Re-attach event listeners to the transferred controls
    attachControlListeners(lyricsPlayerControls);

    const lyricsFile = currentSong.syncedLyrics || currentSong.lyrics;
    if (lyricsFile) {
        fetch(lyricsFile)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lyrics file not found');
                }
                return response.text();
            })
            .then(text => {
                console.log("Lyrics fetched successfully");
                if (currentSong.syncedLyrics) {
                    displaySyncedLyrics(text);
                } else {
                    lyricsContent.textContent = text;
                }
            })
            .catch(error => {
                console.error('Error fetching lyrics:', error);
                lyricsContent.textContent = `Lyrics not yet available for "${currentSong.title}".`;
            });
    } else {
        console.log("No lyrics file found for this song");
        lyricsContent.textContent = `Lyrics not yet available for "${currentSong.title}".`;
    }
}

function attachControlListeners(controlsContainer) {
    const prevBtn = controlsContainer.querySelector('#prevBtn');
    const playPauseBtn = controlsContainer.querySelector('#playPauseBtn, #lyricsPlayPauseBtn');
    const nextBtn = controlsContainer.querySelector('#nextBtn');
    const skip10BackBtn = controlsContainer.querySelector('#skip10BackBtn');
    const skip10AheadBtn = controlsContainer.querySelector('#skip10AheadBtn');
    const repeatBtn = controlsContainer.querySelector('#repeatBtn');

    if (prevBtn) prevBtn.addEventListener('click', playPrevious);
    if (playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
    if (nextBtn) nextBtn.addEventListener('click', playNext);
    if (skip10BackBtn) skip10BackBtn.addEventListener('click', () => skipTime(-10));
    if (skip10AheadBtn) skip10AheadBtn.addEventListener('click', () => skipTime(10));
    if (repeatBtn) repeatBtn.addEventListener('click', toggleRepeat);
}

function displaySyncedLyrics(syncedLyricsText) {
    console.log("Displaying synced lyrics");
    const lyricsContent = document.getElementById('lyricsContent');
    lyricsContent.innerHTML = '';

    const lines = syncedLyricsText.split('\n');
    let parsedLines = [];
    lines.forEach(line => {
        const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);
        if (match) {
            const minutes = parseInt(match[1]);
            const seconds = parseInt(match[2]);
            const centiseconds = parseInt(match[3]);
            const text = match[4].trim();
            const time = minutes * 60 + seconds + centiseconds / 100;

            parsedLines.push({ time, text });
        }
    });

    // Sort lines by time
    parsedLines.sort((a, b) => a.time - b.time);

    parsedLines.forEach(line => {
        const p = document.createElement('p');
        p.textContent = line.text;
        p.dataset.time = line.time;
        lyricsContent.appendChild(p);
    });

    console.log(`Parsed and sorted ${parsedLines.length} lines of lyrics`);

    // Start syncing
    syncLyrics();
}

function syncLyrics() {
    console.log("Syncing lyrics");
    const lyricsContent = document.getElementById('lyricsContent');
    const lines = Array.from(lyricsContent.querySelectorAll('p'));
    console.log(`Found ${lines.length} lyric lines`);

    function updateLyrics() {
        const currentTime = audioPlayer.currentTime;
        console.log(`Current time: ${currentTime}`);

        let activeIndex = -1;
        for (let i = 0; i < lines.length; i++) {
            const lineTime = parseFloat(lines[i].dataset.time);
            if (lineTime <= currentTime) {
                activeIndex = i;
            } else {
                break;
            }
        }

        lines.forEach((line, index) => {
            if (index === activeIndex) {
                if (!line.classList.contains('active')) {
                    line.classList.add('active');
                    console.log(`Activated line: ${line.textContent} at time ${line.dataset.time}`);
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                line.classList.remove('active');
            }
        });

        if (!audioPlayer.paused) {
            requestAnimationFrame(updateLyrics);
        }
    }

    audioPlayer.addEventListener('play', () => {
        console.log("Audio played, updating lyrics");
        updateLyrics();
    });
    audioPlayer.addEventListener('seeking', () => {
        console.log("Audio seeked, updating lyrics");
        updateLyrics();
    });
    audioPlayer.addEventListener('timeupdate', updateLyrics);

    // Start updating immediately if the audio is already playing
    if (!audioPlayer.paused) {
        console.log("Audio is already playing, starting lyrics update");
        updateLyrics();
    }
}

function hideLyrics() {
    const lyricsModal = document.getElementById('lyricsModal');
    const lyricsBtn = document.getElementById('lyricsBtn');
    lyricsModal.style.display = 'none';
    lyricsBtn.title = 'Show Lyrics';
}

      document
        .getElementById("lyricsBtn")
        .addEventListener("click", showLyrics);

      // Initialize the application
      function init() {
        console.log("Starting initialization");
        // Ensure we're using the most recent known device ID
        const deviceId = getDeviceId();
        console.log(`Using device ID: ${deviceId}`);

        currentPlaylistName = "main";
        currentPlaylist = playlist;
        isCustomPlaylistActive = false;

        audioPlayer.addEventListener('play', () => {
    updatePlayPauseButton();
    updateLyricsPlayPauseButton();
  });
        audioPlayer.addEventListener('pause', () => {
    updatePlayPauseButton();
    updateLyricsPlayPauseButton();
  });

        const splashScreen = document.getElementById("splashScreen");
        const openSound = document.getElementById("openSound");
        const enterSiteBtn = document.getElementById("enterSiteBtn");
        const splashImage = splashScreen.querySelector("img");

        // Check if this is a new session
        const isNewSession = !sessionStorage.getItem("appOpened");
        const isFirstVisit = !localStorage.getItem("appEverOpened");

        if ((isNewSession || isFirstVisit) && !isHidden) {
          splashScreen.style.display = "flex";
          enterSiteBtn.style.display = "block";

          // Update the enter button text based on standalone mode
          updateEnterButtonText();

          enterSiteBtn.addEventListener("click", function () {
            enterSiteBtn.classList.add("fade-out");
            enterSiteBtn.style.display = "hidden";
            openSound
              .play()
              .catch((error) => console.log("Error playing sound:", error));

            splashImage.style.animation =
              "fadeOutRotate 4.71s ease-in-out forwards";

            setTimeout(() => {
              hideSplashScreen(splashScreen);
              continueSiteInitialization();
            }, 4710); // 4.71 seconds
          });
        } else {
          splashScreen.style.display = "none";
          continueSiteInitialization();
        }
      }

      function hideSplashScreen(splashScreen) {
        splashScreen.style.opacity = "0";
        splashScreen.style.visibility = "hidden";
        // No need for a setTimeout here, as we're using CSS transitions
      }

      function continueSiteInitialization() {
        // Mark that the app has been opened
        sessionStorage.setItem("appOpened", "true");
        localStorage.setItem("appOpened", "true");

        // Force scroll to top
        window.scrollTo(0, 0);

        // Apply device-specific optimizations early
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
          optimizeForIOS();
        } else if (/Android/i.test(navigator.userAgent)) {
          optimizeForAndroid();
          if (/Samsung/i.test(navigator.userAgent)) {
            optimizeForSamsung();
          }
        }

        initializeUserCount()
          .then(() => {
            setupApproximateUserCountListener();
            updateApproximateUserCount();
          })
          .catch((error) => {
            console.error("Error during user count initialization:", error);
            // Still set up the listener and update the count, even if initialization fails
            setupApproximateUserCountListener();
            updateApproximateUserCount();
          });

        // Sync playlists from Firebase before initializing the app
        getPlaylistsFromFirebase()
          .then((firebasePlaylists) => {
            console.log("Playlists synced from Firebase:", firebasePlaylists);
            return validateAndReloadPlaylists(firebasePlaylists);
          })
          .then((validatedPlaylists) => {
            localStorage.setItem(
              "userPlaylists",
              JSON.stringify(validatedPlaylists)
            );

            // Set the main playlist
            if (validatedPlaylists.main && validatedPlaylists.main.songs) {
              currentPlaylist = validatedPlaylists.main.songs;
              playlist = currentPlaylist;
            }

            return createDefaultPlaylistIfNeeded();
          })
          .then(() => {
            // Continue with app initialization
            displayMainPlaylist(currentPlaylist);
            updateSidebarPlaylist();
            setupBackgroundPlayback();
            setupEventListeners();
            handleVolumeMobile();
            updatePlaylistButtonText();
            setupSidebarScroll();
            setupSearchInputListener();
            setupPlaylistSongsDragAndDrop();
            enableDragAndDrop();
            setupPlaylistEventListeners();
            handleAudioFocus();
            setupSyncOptionsModal();
            setupPlayerControls();
            setupIndividualPlayCountListeners();
            setupApproximateUserCountListener();
            updateApproximateUserCount();
            setupLyricsControls();
            setupLyricsButtons();

            if (/Android/i.test(navigator.userAgent)) {
              handleAndroidAudioFocus();
            }

            return acquireWakeLock();
          })
          .then(() => {
            console.log("Wake lock acquired");
            // Display playlists after all initialization is complete
            return displayPlaylists();
          })
          .catch((error) => {
            console.error("Error during initialization:", error);
            // You might want to add some error handling or user notification here
          })
          .finally(() => {
            console.log("Initialization complete");
            updateTotalPlayCount();
            setupPlayCountListener();
          });
      }

      function validateAndReloadPlaylists(playlists) {
        const deviceId = getDeviceId();
        const reloadPromises = [];

        for (const [name, playlistData] of Object.entries(playlists)) {
          if (!playlistData.songs || playlistData.songs.length === 0) {
            console.log(
              `Playlist "${name}" is empty. Attempting to reload from Firebase.`
            );
            const reloadPromise = firebase
              .database()
              .ref(`playlists/${deviceId}/${name}`)
              .once("value")
              .then((snapshot) => {
                const reloadedPlaylist = snapshot.val();
                if (
                  reloadedPlaylist &&
                  reloadedPlaylist.songs &&
                  reloadedPlaylist.songs.length > 0
                ) {
                  console.log(
                    `Successfully reloaded playlist "${name}" from Firebase.`
                  );
                  playlists[name] = reloadedPlaylist;
                } else {
                  console.error(
                    `Failed to reload playlist "${name}" from Firebase. It may be genuinely empty.`
                  );
                }
              });
            reloadPromises.push(reloadPromise);
          }
        }

        return Promise.all(reloadPromises).then(() => playlists);
      }

      // Add event listener for visibility change
      document.addEventListener("visibilitychange", function () {
        isHidden = document.hidden;
      });

      // Add event listener for the main header
      const mainHeader = document.getElementById("mainHeader");
      if (mainHeader) {
        mainHeader.addEventListener("click", () => {
          backToMainPlaylist();
          if (playlistSidebar.classList.contains("open")) {
            togglePlaylist();
          }
        });
      }

      // Make sure to call init when the DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        checkVersion();
        cacheBustAssets();
        init();
      });

      // Add this to handle cases where the page is reloaded
      window.addEventListener("beforeunload", function () {
        sessionStorage.removeItem("appOpened");
        // We're not clearing localStorage here, so it remembers across sessions
      });

      // Register service worker
      if (
        "serviceWorker" in navigator &&
        location.hostname !== "localhost" &&
        location.hostname !== "127.0.0.1"
      ) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((registration) => {
              console.log(
                "Service Worker registered with scope:",
                registration.scope
              );
              registration.addEventListener("updatefound", () => {
                const newWorker = registration.installing;
                newWorker.addEventListener("statechange", () => {
                  if (newWorker.state === "installed") {
                    if (navigator.serviceWorker.controller) {
                      // New content is available, notify the user
                      showUpdateNotification();
                    }
                  }
                });
              });
            })
            .catch((error) => {
              console.error("Service Worker registration failed:", error);
            });
        });
      }

      function showUpdateNotification() {
        const notification = document.createElement("div");
        notification.textContent =
          "A new version is available. Please refresh the page to update.";
        notification.style.position = "fixed";
        notification.style.top = "0";
        notification.style.left = "0";
        notification.style.right = "0";
        notification.style.backgroundColor = "#4CAF50";
        notification.style.color = "white";
        notification.style.textAlign = "center";
        notification.style.padding = "10px";
        document.body.appendChild(notification);
      }
    </script>
  </body>
</html>
